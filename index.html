<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رحلتي في الإسلامية</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #006633;
            --primary-dark: #004422;
            --secondary-color: #fdd835;
            --light-bg: #e6f3ee;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --info-color: #17a2b8;
            --font-family: 'Cairo', sans-serif;
            --text-dark: #333;
            --text-light: #555;
            --white-color: #fff;
            --border-radius-main: 15px;
        }

        body {
            font-family: var(--font-family);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--text-dark);
            padding: 10px;
            padding-top: 80px;
            box-sizing: border-box;
            background-image: url('Ferst.webp');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(240, 244, 248, 0.85);
            z-index: -1;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        #landing-screen {
            background-color: transparent;
            padding: 30px 40px;
            border-radius: 0;
            box-shadow: none;
            text-align: center;
            animation: fadeInUp 0.6s ease-out;
            width: 100%;
        }

        .logo {
            max-width: 150px;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 32px;
            line-height: 1.4;
            font-weight: 700;
        }

        .subtitle {
            font-size: 18px;
            color: var(--text-light);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .features-grid {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
        }

        .feature-card {
            background-color: var(--white-color);
            padding: 25px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: calc(33.33% - 20px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .feature-card .icon {
            font-size: 48px;
            color: var(--primary-color);
            display: block;
            margin-bottom: 15px;
        }

        .feature-card h3 {
            color: var(--primary-color);
            font-size: 20px;
            margin-bottom: 10px;
        }

        .feature-card p {
            font-size: 14px;
            color: #777;
            line-height: 1.5;
            margin: 0;
        }
        
        .reset-link-container {
            margin-top: 20px;
            font-size: 14px;
        }
        .reset-link-container a {
            color: var(--text-light);
            text-decoration: none;
        }
        .reset-link-container a:hover {
            text-decoration: underline;
            color: var(--primary-color);
        }

        #start-screen {
            background-color: var(--white-color);
            padding: 30px 40px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            animation: fadeInUp 0.6s ease-out;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: var(--font-family);
        }

        .action-button {
            width: 100%;
            max-width: 350px;
            padding: 15px;
            border: none;
            border-radius: 30px;
            background-color: var(--primary-color);
            color: var(--white-color);
            font-size: 18px;
            font-weight: bold;
            font-family: var(--font-family);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }

        .action-button:hover {
            background-color: var(--primary-dark);
            transform: scale(1.02);
        }

        .action-button:disabled {
            background-color: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-icon {
            transform: scaleX(-1);
        }

        .hidden {
            display: none !important;
        }

        .game-stage {
            background-color: var(--white-color);
            padding: 0;
            border-radius: var(--border-radius-main);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        .scene-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .scene-content {
            padding: 25px;
        }

        .scene-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 20px;
        }

        .guide-help-button {
            background-color: var(--info-color);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            border: none;
            font-family: var(--font-family);
            font-size: 16px;
            cursor: pointer;
            position: relative;
            z-index: 10;
            transition: all 0.3s ease;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .guide-help-button:hover {
            background-color: #117a8b;
            transform: translateY(-2px);
        }
        .guide-help-button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
            transform: none;
        }

        .power-ups-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .power-up-btn {
            background-color: #ffc107;
            color: var(--text-dark);
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-family: var(--font-family);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .power-up-btn:hover:not(:disabled) {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        .power-up-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        .power-up-counter {
            background-color: rgba(0,0,0,0.2);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
        }


        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }

        .option-btn {
            position: relative;
            padding: 15px 10px;
            border: 2px solid var(--primary-color);
            background-color: var(--white-color);
            color: var(--primary-color);
            font-size: 16px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }

        .option-btn:hover {
            background-color: var(--light-bg);
            transform: translateY(-2px);
        }

        .option-btn.correct {
            background-color: var(--correct-color);
            color: var(--white-color);
            border-color: var(--correct-color);
        }
        .option-btn.correct:hover {
            background-color: var(--correct-color);
        }
        .option-btn.incorrect {
            background-color: var(--incorrect-color);
            color: var(--white-color);
            border-color: var(--incorrect-color);
        }
        .option-btn.incorrect:hover {
            background-color: var(--incorrect-color);
        }
        
        .option-btn.correct::before, .option-btn.incorrect::before {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
        }

        .option-btn.correct::before { content: '✓'; }
        .option-btn.incorrect::before { content: '✗'; }
        
        .feedback-message {
            opacity: 0;
            transform: translateY(10px);
            visibility: hidden;
            transition: opacity 0.4s ease-out, transform 0.4s ease-out, visibility 0.4s;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: var(--white-color);
        }

        .feedback-message.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .feedback-message.correct { background-color: var(--correct-color); }
        .feedback-message.incorrect { background-color: var(--incorrect-color); }
        .feedback-message.info { background-color: var(--info-color); }

        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            direction: rtl;
        }

        .modal-content {
            background-color: var(--white-color);
            padding: 30px;
            border-radius: var(--border-radius-main);
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: slide-down 0.4s ease-out;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
        }
        .modal-actions .action-button {
            width: auto;
            max-width: none;
            padding: 12px 30px;
            flex-grow: 1;
        }
        .modal-actions .action-button.danger {
            background-color: var(--incorrect-color);
        }
        .modal-actions .action-button.danger:hover {
            background-color: #a71d2a;
        }
        .modal-actions .action-button.secondary {
            background-color: #6c757d;
        }
        .modal-actions .action-button.secondary:hover {
            background-color: #5a6268;
        }

        @keyframes slide-down {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate3d(0, 30px, 0); }
            to { opacity: 1; transform: translate3d(0, 0, 0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .modal-content p {
            color: var(--text-light);
            font-size: 16px;
        }
        
        #map-scene .options-container .option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 18px;
            padding: 25px 15px;
        }

        .map-icon {
            font-size: 36px;
            margin-bottom: 5px;
        }

        .progress-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            width: 95%;
            margin: 10px auto 20px;
        }

        .progress-bar-container {
            flex-grow: 1;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            height: 12px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
            margin: 0;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            background-color: var(--primary-color);
            transition: width 0.5s ease;
        }

        .question-counter {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-light);
            white-space: nowrap;
        }

        .timer-container {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-dark);
            background-color: var(--light-bg);
            border: 2px solid var(--primary-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .timer-container.low-time {
            background-color: #fffbe6;
            border-color: var(--incorrect-color);
            color: var(--incorrect-color);
            transform: scale(1.1);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1.1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1.1); }
        }


        #faculties-scene .options-container,
        #exchange-scene .options-container,
        #admission-scene .options-container,
        #studentaffairs-scene .options-container {
            grid-template-columns: 1fr;
            max-width: 400px;
            margin: 25px auto 0;
        }

        #faculties-scene .option-btn,
        #exchange-scene .option-btn,
        #admission-scene .option-btn,
        #studentaffairs-scene .option-btn {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 20px;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #faculties-scene .option-btn:hover,
        #exchange-scene .option-btn:hover,
        #admission-scene .option-btn:hover,
        #studentaffairs-scene .option-btn:hover {
            transform: scale(1.03);
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        #faculties-scene .option-btn span,
        #exchange-scene .option-btn span,
        #admission-scene .option-btn span,
        #studentaffairs-scene .option-btn span {
            font-size: 30px;
        }

        #grants-info-scene .scene-content,
        #faculties-info-scene .scene-content,
        #studentaffairs-info-scene .scene-content {
            padding: 0;
        }

        .info-header {
            padding: 25px 25px 20px 25px;
            border-bottom: 1px solid #eee;
        }
        
        .info-scene-container {
            max-height: 60vh;
            overflow-y: auto;
            padding: 20px 25px;
            text-align: right;
        }

        #studentaffairs-info-scene .tabs-nav {
            display: flex;
            border-bottom: 1px solid #ddd;
            padding: 0 25px;
        }
        #studentaffairs-info-scene .tab-btn {
            padding: 15px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-family: var(--font-family);
            font-size: 16px;
            font-weight: bold;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        #studentaffairs-info-scene .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        #studentaffairs-info-scene .tab-pane {
            display: none;
            animation: fadeIn 0.5s;
        }
        #studentaffairs-info-scene .tab-pane.active {
            display: block;
        }
        #studentaffairs-info-scene .info-section-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
        }
        #studentaffairs-info-scene .info-list {
            list-style: none;
            padding-right: 0;
        }
        #studentaffairs-info-scene .info-list li {
            font-size: 16px;
            color: var(--text-light);
            line-height: 1.7;
            margin-bottom: 10px;
            padding-right: 25px;
            position: relative;
        }
        #studentaffairs-info-scene .info-list li::before {
            content: '🔹';
            position: absolute;
            right: 0;
            top: 2px;
            color: var(--primary-color);
        }
        #studentaffairs-info-scene .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        #studentaffairs-info-scene .photo-gallery img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #studentaffairs-info-scene .accordion-item {
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        #studentaffairs-info-scene .accordion-header {
            background-color: #f9f9f9;
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #studentaffairs-info-scene .accordion-header::after {
            content: '▼';
            transition: transform 0.3s ease;
        }
        #studentaffairs-info-scene .accordion-item.active .accordion-header::after {
            transform: rotate(180deg);
        }
        #studentaffairs-info-scene .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 15px;
            background: #fff;
        }
        #studentaffairs-info-scene .accordion-item.active .accordion-content {
            padding: 15px;
        }
        
        .grant-category,
        .exchange-category {
            font-size: 22px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-top: 20px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-color);
        }
        .grant-category:first-child,
        .exchange-category:first-child {
            margin-top: 0;
        }
        
        .grant-card,
        .exchange-card {
            background-color: #f9f9f9;
            border-right: 5px solid var(--primary-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-right-color 0.3s ease;
        }
        .grant-card:hover,
        .exchange-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-right-color: var(--secondary-color);
        }
        
        .grant-card h3,
        .exchange-card h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: var(--primary-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grant-percentage,
        .exchange-project {
            background-color: var(--secondary-color);
            color: var(--text-dark);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
        }

        .grant-details ul,
        .exchange-details ul {
            list-style: none;
            padding-right: 0;
            margin: 0;
            font-size: 14px;
            color: var(--text-light);
        }

        .grant-details li,
        .exchange-details li {
            padding-right: 25px;
            position: relative;
            margin-bottom: 8px;
        }
        .grant-details li::before,
        .exchange-details li::before {
            content: '🔹';
            position: absolute;
            right: 0;
            top: 0;
            color: var(--primary-color);
        }

        .info-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
        }
        
        #faculties-info-scene .info-scene-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .college-card {
            background-color: #f9f9f9;
            border-top: 5px solid var(--primary-color);
            border-radius: var(--border-radius-main);
            padding: 25px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .college-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .college-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary-dark);
        }
        
        .college-card h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: var(--primary-color);
        }

        .college-card p {
            font-size: 15px;
            color: var(--text-light);
            line-height: 1.6;
            margin: 0;
        }
        
        #faculties-list-scene .info-scene-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            text-align: right;
        }

        .college-info-card {
            background-color: #f9f9f9;
            border-right: 5px solid var(--primary-color);
            border-radius: var(--border-radius-main);
            padding: 25px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .college-info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-right-color: var(--secondary-color);
        }

        .college-info-card h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: var(--primary-dark);
        }

        .college-info-card p {
            font-size: 15px;
            color: var(--text-light);
            line-height: 1.6;
            margin: 0;
        }

        #college-website-scene .scene-content {
            padding: 20px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .website-view-header {
            margin-bottom: 15px;
            display: flex;
            justify-content: flex-end;
        }

        .loader-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--text-light);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #college-website-iframe {
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #college-website-iframe.loaded {
            opacity: 1;
        }

        .admission-card {
            background-color: #f9f9f9;
            border-right: 5px solid var(--primary-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: right;
        }
        
        .admission-card h3 {
            font-size: 20px;
            color: var(--primary-dark);
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .admission-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .admission-card li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .admission-card li:last-child {
            border-bottom: none;
        }

        .admission-card .specialization {
            font-size: 16px;
            color: var(--text-dark);
        }

        .admission-card .score {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
            background-color: var(--light-bg);
            padding: 4px 10px;
            border-radius: 20px;
        }
        
        .admission-card .score.new-major {
            background-color: var(--secondary-color);
            color: var(--text-dark);
        }

        #status-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--primary-dark);
            color: var(--white-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 25px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            box-sizing: border-box;
            border-bottom: 3px solid var(--secondary-color);
            transition: top 0.3s ease-in-out;
        }

        #status-bar.hidden {
            top: -100px;
        }

        .status-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #player-name-display {
            font-weight: bold;
            font-size: 17px;
        }

        #player-score-display {
            background-color: var(--secondary-color);
            color: var(--text-dark);
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
        }

        .status-bar-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white-color);
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .status-bar-btn:hover {
            background-color: var(--incorrect-color);
            border-color: var(--incorrect-color);
            transform: translateY(-2px);
        }
        
        .status-bar-btn#back-to-map-btn:hover {
            background-color: var(--info-color);
            border-color: var(--info-color);
        }
        /* تعديل جديد: زر "الملف الشخصي" */
        .status-bar-btn#profile-btn {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .status-bar-btn#profile-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: var(--white-color);
            transform: translateY(-2px);
        }
        .status-section .icon {
            font-size: 22px;
        }

        .ad-modal-content {
            position: relative;
            background-color: transparent;
            padding: 0;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            border-radius: var(--border-radius-main);
            animation: fadeInUp 0.5s;
        }

        .ad-modal-content img {
            width: 100%;
            display: block;
            border-radius: var(--border-radius-main);
        }

        .close-ad-btn {
            position: absolute;
            top: -15px;
            right: -15px;
            color: #000;
            background-color: var(--white-color);
            font-size: 35px;
            font-weight: bold;
            width: 40px;
            height: 40px;
            line-height: 35px;
            text-align: center;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .close-ad-btn:hover {
            transform: scale(1.1) rotate(90deg);
            color: var(--incorrect-color);
        }
        
        #video-overlay {
            flex-direction: column;
            gap: 20px;
            z-index: 3000;
        }

        #skip-video-btn {
            width: auto;
            padding: 12px 30px;
            background-color: var(--incorrect-color);
            position: absolute;
            bottom: 30px;
            z-index: 3001;
        }

        #skip-video-btn:hover {
            background-color: #a71d2a;
        }
        
        .guides-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .guide-card {
            background-color: var(--white-color);
            border: 3px solid transparent;
            border-radius: var(--border-radius-main);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .guide-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .guide-card.selected {
            border-color: var(--primary-color);
            background-color: var(--light-bg);
            transform: translateY(-8px);
        }

        .guide-icon {
            font-size: 64px;
            line-height: 1;
            margin-bottom: 15px;
            background-color: var(--light-bg);
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 4px solid var(--primary-color);
        }

        .guide-card h3 {
            margin: 0 0 5px 0;
            font-size: 20px;
            color: var(--primary-dark);
        }

        .guide-card span {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
            margin-bottom: 10px;
            min-height: 20px;
        }

        .guide-card p {
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.5;
            margin: 0;
            flex-grow: 1;
        }
        
        @media (max-width: 600px) {
            .options-container {
                grid-template-columns: 1fr;
            }

            .features-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            .feature-card {
                width: auto; 
                margin-bottom: 0;
            }

            #status-bar {
                padding: 8px 10px;
                flex-direction: column;
                gap: 5px;
                align-items: stretch;
            }

            .status-section {
                width: 100%;
                justify-content: space-between;
                gap: 8px;
            }

            #player-name-display {
                font-size: 15px;
            }

            #player-score-display {
                font-size: 14px;
                padding: 5px 12px;
            }

            .status-bar-btn {
                font-size: 13px;
                padding: 6px 10px;
                gap: 5px;
            }

            .status-section .icon {
                font-size: 20px;
            }

            body {
                padding-top: 125px;
            }
            .guides-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* CSS جديد لنظام الشارات */
        .badge-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--primary-dark);
            color: var(--white-color);
            padding: 30px;
            border-radius: var(--border-radius-main);
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 5000;
            animation: fadeInScale 0.5s ease-out;
            width: 90%;
            max-width: 400px;
        }
        
        .badge-popup h3 {
            font-size: 24px;
            margin: 0 0 10px 0;
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        .badge-popup .badge-icon {
            font-size: 80px;
            margin-bottom: 15px;
            animation: bounceIn 0.8s ease-out;
            display: block;
        }
        
        .badge-popup p {
            font-size: 18px;
            margin: 0;
        }

        .badges-profile-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .badge-card {
            background-color: var(--light-bg);
            border-radius: var(--border-radius-main);
            padding: 15px;
            text-align: center;
            width: 100px;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .badge-card .badge-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }
        .badge-card p {
            font-size: 12px;
            font-weight: bold;
            color: var(--primary-dark);
            margin: 0;
            line-height: 1.3;
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes bounceIn {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-30px);
            }
            60% {
                transform: translateY(-15px);
            }
        }
        /* ========== بداية تنسيقات لعبة الملعب ========== */
#stadium-scene .scene-content {
    padding: 15px;
    background-color: #388E3C; /* لون عشبي */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    height: 100%;
}

.stadium-game-board {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    aspect-ratio: 4 / 3;
    background-image: 
        linear-gradient(rgba(255,255,255,0.1) 2px, transparent 2px),
        linear-gradient(90deg, rgba(255,255,255,0.1) 2px, transparent 2px);
    background-size: 40px 40px;
    background-color: #4CAF50;
    position: relative;
    border: 5px solid #FFF;
    border-top: none;
    overflow: hidden;
}

.stadium-goal {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 60%;
    border: 5px solid #FFF;
    border-bottom: none;
    box-sizing: border-box;
}
.stadium-goal::before, .stadium-goal::after { /* Net pattern */
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        linear-gradient(rgba(255,255,255,0.3) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.3) 1px, transparent 1px);
    background-size: 20px 20px;
    z-index: 1;
}

.stadium-keeper {
    position: absolute;
    bottom: 5px; /* لرفع الحارس قليلاً ليتناسب مع الإيموجي الجديد */
    left: 50%;
    font-size: 60px; /* حجم الإيموجي */
    background-color: transparent;
    border: none;
    transform: translateX(-50%);
    transition: left 0.3s ease-in-out;
    z-index: 3;
}

.stadium-ball {
    position: absolute;
    bottom: 15px; /* لرفع اللاعب ليكون على خط الملعب */
    left: 50%;
    font-size: 35px; /* حجم اللاعب مع الكرة */
    background-color: transparent;
    transform: translateX(-50%);
    transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
    z-index: 2;
}

.stadium-controls {
    text-align: center;
    width: 100%;
}

.stadium-instructions {
    color: var(--white-color);
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
}

.stadium-score-board {
    display: flex;
    justify-content: space-around;
    width: 100%;
    max-width: 400px;
    background-color: rgba(0, 0, 0, 0.4);
    padding: 10px;
    border-radius: 10px;
    color: white;
    font-size: 20px;
    font-weight: bold;
    margin-top: 15px;
}

.stadium-shots-indicator {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 10px;
}

.shot-dot {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background-color: rgba(255,255,255,0.5);
    border: 1px solid white;
}
.shot-dot.goal { background-color: #28a745; }
.shot-dot.saved { background-color: #dc3545; }

/* ========== نهاية تنسيقات لعبة الملعب ========== */
/* ========== بداية تنسيقات لعبة الذاكرة ========== */
#memory-game-scene .scene-content {
    padding: 20px;
    background-color: #e6f3ee; /* light-bg color */
}

.memory-game-title {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary-dark);
    margin-bottom: 20px;
    text-align: center;
}

.memory-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
    perspective: 1000px; /* For 3D flip effect */
}

.memory-card {
    width: 100%;
    aspect-ratio: 1 / 1;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.6s;
    cursor: pointer;
}

.memory-card.flipped,
.memory-card.matched {
    transform: rotateY(180deg);
}

.card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.card-front {
    background-color: var(--primary-color);
    color: var(--white-color);
    font-size: 3em;
    background-image: url('logo.webp'); /* Using existing logo */
    background-size: 60%;
    background-repeat: no-repeat;
    background-position: center;
}

.card-back {
    background-color: var(--white-color);
    color: var(--primary-dark);
    transform: rotateY(180deg);
    font-size: 2.5em;
}

.memory-card.matched .card-back {
    background-color: #d4edda; /* Light green for matched cards */
    border: 2px solid var(--correct-color);
}
/* ========== نهاية تنسيقات لعبة الذاكرة ========== */
    </style>
</head>
<body>

    <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
    <audio id="incorrect-sound" src="funny.mp3" preload="auto"></audio>
    <audio id="transition-sound" src="turning.mp3" preload="auto"></audio>
    <audio id="guide-appears-sound" src="guide_appears.mp3" preload="auto"></audio>
    <audio id="badge-sound" src="badge.mp3" preload="auto"></audio>

    <div id="status-bar" class="hidden">
        <div class="status-section">
            <span class="icon">👤</span>
            <span id="player-name-display"></span>
            <span id="player-score-display"></span>
        </div>
        <div class="status-section">
            <a href="#" id="profile-btn" class="status-bar-btn" aria-label="الملف الشخصي">
                <span class="icon">⭐</span>
                الملف الشخصي
            </a>
            <a href="#" id="back-to-map-btn" class="status-bar-btn" aria-label="العودة إلى الخريطة">
                <span class="icon">🗺️</span>
                الخريطة
            </a>
            <a href="#" id="logout-btn" class="status-bar-btn" aria-label="الخروج وبدء رحلة جديدة">
                <span class="icon">🚪</span>
                خروج
            </a>
        </div>
    </div>
    <div class="game-container">
        <div id="landing-screen">
            <img src="logo.webp" alt="شعار الجامعة الإسلامية" class="logo" loading="lazy">
            <h1>رحلتك نحو المعرفة والتميز تبدأ الآن</h1>
            <p class="subtitle">تطلق الجامعة الإسلامية بغزة مسابقة تفاعلية فريدة لطلبة الثانوية العامة، استعد لتحدي معلوماتك والفوز بجوائز قيمة.</p>
            <div class="features-grid">
                <div class="feature-card">
                    <span class="icon">🎓</span>
                    <h3>حوّلها إلى منحة</h3>
                    <p>حوّل أرباحك لمنحة دراسية حقيقية عند التحاقك بالجامعة.</p>
                </div>
                <div class="feature-card">
                    <span class="icon">💰</span>
                    <h3>اربح جوائز فورية</h3>
                    <p>اجمع "نقاط" إلكترونية مع كل إجابة صحيحة تضاف إلى رصيدك.</p>
                </div>
                <div class="feature-card">
                    <span class="icon">🏆</span>
                    <h3>تحديات ممتعة</h3>
                    <p>أجب عن أسئلة شيقة في مجالات متنوعة واختر تخصصك.</p>
                </div>
            </div>
            <button id="show-register-btn" class="action-button">
                <span class="btn-icon">📅</span> لا تفوّت الفرصة - سجّل الآن!
            </button>
            <p class="reset-link-container">
                <a href="#" id="reset-progress-btn">هل تريد بدء رحلة جديدة؟ (سيتم حذف التقدم الحالي)</a>
            </p>
        </div>

        <div id="start-screen" class="hidden">
            <img src="logo.webp" alt="شعار الجامعة الإسلامية" class="logo" loading="lazy">
            <h1>أهلاً بك في رحلتك الافتراضية</h1>
            <p>استكشف الجامعة الإسلامية، أجب عن التحديات، واربح منحة دراسية حقيقية!</p>
            <form id="player-form">
                <div class="form-group">
                    <label for="name">الاسم الكامل:</label>
                    <input type="text" id="name" placeholder="مثال: أحمد علي" required minlength="5">
                </div>
                <div class="form-group">
                    <label for="phone">رقم الجوال:</label>
                    <input type="tel" id="phone" pattern="^05[9|6|4][0-9]{7}$" placeholder="مثال: 059xxxxxxx" required>
                </div>
                <div class="form-group">
                    <label for="tawjihi-year">سنة التوجيهي:</label>
                    <input type="number" id="tawjihi-year" placeholder="مثال: 2024" required min="2000">
                </div>
                <button type="submit" class="action-button" disabled>ابدأ الرحلة!</button>
            </form>
        </div>

        <div id="guide-selection-screen" class="game-stage hidden">
            <div class="scene-content">
                <h2 class="scene-title">اختر مرشدك في الرحلة</h2>
                <p>كل مرشد سيقدم لك نصائح من منظور تخصصه الفريد!</p>
                <div class="guides-container">
                </div>
                <button id="confirm-guide-btn" class="action-button" disabled style="margin-top: 30px;">
                    تأكيد المرشد والبدء
                </button>
            </div>
        </div>
        
        <div id="player-profile-scene" class="game-stage hidden">
            <div class="scene-content" style="text-align: right;">
                <h2 class="scene-title">الملف الشخصي</h2>
                <div class="profile-info">
                    <h3 style="display: flex; align-items: center; gap: 10px; color: var(--primary-dark);">
                        <span id="profile-emoji" style="font-size: 30px;"></span>
                        <span id="profile-name"></span>
                    </h3>
                    <p>
                        <span style="font-weight: bold; color: var(--primary-color);">النقاط:</span>
                        <span id="profile-score"></span>
                    </p>
                    <p>
                        <span style="font-weight: bold; color: var(--primary-color);">سنة التوجيهي:</span>
                        <span id="profile-tawjihi-year"></span>
                    </p>
                </div>
                <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">
                    🏅 الشارات والإنجازات
                </h3>
                <div id="badges-container" class="badges-profile-container">
                    <p id="no-badges-msg" style="color: var(--text-light);">
                        لم تحصل على أي شارات بعد.
                    </p>
                </div>
            </div>
            <div class="info-footer">
                <button id="profile-back-btn" class="action-button">
                    <span class="btn-icon">⬅️</span> العودة
                </button>
            </div>
        </div>

        <div id="game-scene" class="hidden">
            
            <div id="gate-scene" class="game-stage hidden"></div>
            <div id="map-scene" class="game-stage hidden">
                <div class="scene-content">
                    <h2 class="scene-title">خريطة الجامعة</h2>
                    <p>لقد دخلت الحرم الجامعي! اختر وجهتك التالية لاستكمال رحلتك.</p>
                    <div class="options-container">
                        <button class="option-btn" data-destination="library"><span class="map-icon">📚</span> المكتبة المركزية</button>
                        <button class="option-btn" data-destination="cafeteria"><span class="map-icon">☕</span> الكافتيريا</button>
                        <button class="option-btn" data-destination="faculties-list"><span class="map-icon">🏢</span> الكليات</button>
                        <button class="option-btn" data-destination="grants-info"><span class="map-icon">💰</span> المنح والمساعدات</button>
                        <button class="option-btn" data-destination="hospital"><span class="map-icon">🏥</span> المستشفى الجامعي</button>
                        <button class="option-btn" data-destination="admission-info"><span class="map-icon">📝</span> القبول والتسجيل</button>
                        <button class="option-btn" data-destination="studentaffairs-info"><span class="map-icon">🧑‍🎓</span> شؤون الطلبة</button>
                        <button class="option-btn" data-destination="conference"><span class="map-icon">🏛️</span> قاعة المؤتمرات</button>
                        <button class="option-btn" data-destination="stadium"><span class="map-icon">🏟️</span> ملعب الجامعة</button>
                        <button class="option-btn" data-destination="exchange-info"><span class="map-icon">🌍</span> التبادل الأكاديمي</button>
                        <button class="option-btn" data-destination="certificate" style="grid-column: 1 / -1;"><span class="map-icon">📜</span> الحصول على الشهادة</button>
                    </div>
                </div>
            </div>
            
            <div id="faculties-list-scene" class="game-stage hidden">
                <div class="scene-content">
                    <div class="info-header">
                        <h2 class="scene-title">🏢 استكشف كليات الجامعة</h2>
                        <p>تعرّف على عالم كل كلية! اضغط على أي بطاقة لتصفح موقعها الرسمي، أو ابدأ تحدي المعلومات مباشرة.</p>
                    </div>
                    
                    <div class="info-scene-container" id="faculties-grid-container">
                    </div>

                    <div class="info-footer">
                        <button id="proceed-to-faculties-quiz-btn" class="action-button">
                            أنا جاهز... ابدأ تحدي الكليات!
                            <span class="btn-icon">🧠</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="college-website-scene" class="game-stage hidden">
            </div>

            <div id="faculties-scene" class="game-stage hidden"></div>
            <div id="tf_questions-scene" class="game-stage hidden"></div>
            <div id="mc_questions-scene" class="game-stage hidden"></div>
            <div id="exchange-scene" class="game-stage hidden"></div>
            <div id="exchange_tf_questions-scene" class="game-stage hidden"></div>
            <div id="exchange_mc_questions-scene" class="game-stage hidden"></div>
            <div id="library-scene" class="game-stage hidden"></div>
            
            <div id="admission-info-scene" class="game-stage hidden">
                <div class="scene-content">
                    <div class="info-header">
                        <h2 class="scene-title">📝 مفتاح التنسيق 2024-2025</h2>
                        <p>اطلع على معدلات القبول المطلوبة لكليات الجامعة المختلفة قبل بدء التحدي.</p>
                    </div>
                    
                    <div class="info-scene-container" id="admission-info-container">
                    </div>
                    
                    <div class="info-footer">
                        <button id="start-admission-quiz-btn" class="action-button">
                            فهمت... ابدأ التحدي الآن!
                            <span class="btn-icon">💡</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="admission-scene" class="game-stage hidden"></div>
            <div id="admission_tf_questions-scene" class="game-stage hidden"></div>
            <div id="admission_mc_questions-scene" class="game-stage hidden"></div>
            
            <div id="grants-info-scene" class="game-stage hidden">
                <div class="scene-content">
                    <div class="info-header">
                        <h2 class="scene-title">💰 دليل المنح والمساعدات الطلابية</h2>
                        <p>المعرفة قوة! قبل أن تبدأ التحدي، اطلع على دليل المنح الشامل الذي تقدمه الجامعة. كل معلومة هنا قد تكون مفتاحك للحصول على دعم كبير.</p>
                    </div>
                    
                    <div class="info-scene-container">
                        <h3 class="grant-category">🏆 منح التفوق الأكاديمي</h3>
                        <div class="grant-card">
                            <h3>🥇 منحة الامتياز (حسب المعدل الفصلي) <span class="grant-percentage">70%</span></h3>
                            <div class="grant-details"><ul><li>المعدل المطلوب: 95% - 100% فصلياً</li><li>يجب اجتياز 15 ساعة معتمدة على الأقل.</li></ul></div>
                        </div>
                        <div class="grant-card">
                            <h3>🥈 منحة الامتياز (حسب المعدل الفصلي) <span class="grant-percentage">35%</span></h3>
                            <div class="grant-details"><ul><li>المعدل المطلوب: 90% - 94.9% فصلياً</li><li>يجب اجتياز 15 ساعة معتمدة على الأقل.</li></ul></div>
                        </div>
                        <div class="grant-card">
                            <h3>🎖️ منحة وزارة التربية والتعليم <span class="grant-percentage">70%+</span></h3>
                            <div class="grant-details"><ul><li>المعدل المطلوب: أعلى معدلين في كل كلية</li><li>للاستمرارية: معدل فصلي 80%</li><li>يتم اختيارهم عبر الوزارة.</li></ul></div>
                        </div>

                        <h3 class="grant-category">🎓 منح التخصصات الأكاديمية</h3>
                        <div class="grant-card">
                            <h3>🕌 المنحة الشرعية <span class="grant-percentage">70%</span></h3>
                            <div class="grant-details"><ul><li>للتخصصات: الشريعة الإسلامية، أصول الدين (عام)</li><li>معدل الثانوية: 80% فأكثر</li><li>للاستمرارية: معدل فصلي 80%</li></ul></div>
                        </div>
                            <div class="grant-card">
                            <h3>📚 المنحة الشرعية <span class="grant-percentage">35%</span></h3>
                            <div class="grant-details"><ul><li>للتخصصات: الشريعة الإسلامية، أصول الدين (عام)</li><li>معدل الثانوية: 70% - 79.9%</li><li>للاستمرارية: معدل فصلي 80%</li></ul></div>
                        </div>
                        <div class="grant-card">
                            <h3>🧪 منح كلية العلوم (فيزياء وكيمياء) <span class="grant-percentage">70%</span></h3>
                            <div class="grant-details"><ul><li>منحتان كاملتان سنوياً لكل تخصص (فيزياء/كيمياء)</li><li>للمتفوقين في الثانوية العامة والمادة العلمية.</li></ul></div>
                        </div>

                        <h3 class="grant-category">✨ منح المواهب والفئات الخاصة</h3>
                        <div class="grant-card">
                            <h3>📖 منحة حفظة القرآن الكريم <span class="grant-percentage">50%</span></h3>
                            <div class="grant-details"><ul><li>للاستمرارية: معدل فصلي 80%</li><li>يجب النجاح في امتحان التسميع لكامل القرآن.</li></ul></div>
                        </div>
                        <div class="grant-card">
                            <h3>🏃 المنحة الرياضية <span class="grant-percentage">25-35%</span></h3>
                            <div class="grant-details"><ul><li>للاستمرارية: معدل فصلي 65%</li><li>للطلبة الملتحقين بفرق الجامعة الرياضية.</li></ul></div>
                        </div>
                        <div class="grant-card">
                            <h3>♿ منحة ذوي الاحتياجات الخاصة <span class="grant-percentage">35-70%</span></h3>
                            <div class="grant-details"><ul><li>للاستمرارية: معدل فصلي 65%</li><li>35% للإعاقة (50-69%)، و 70% للإعاقة (70% فأكثر).</li></ul></div>
                        </div>

                        <h3 class="grant-category">👨‍👩‍👧‍👦 منح الدعم الأسري والمجتمعي</h3>
                        <div class="grant-card">
                            <h3>🧑‍🤝‍🧑 منحة الأسرة (شقيقان) <span class="grant-percentage">15%</span></h3>
                            <div class="grant-details"><ul><li>للاستمرارية: معدل 70% (75% للطب)</li><li>لكل طالب على حدة.</li></ul></div>
                        </div>
                            <div class="grant-card">
                            <h3>👪 منحة الأسرة (3 أشقاء) <span class="grant-percentage">25%</span></h3>
                            <div class="grant-details"><ul><li>للاستمرارية: معدل 70% (75% للطب)</li><li>لكل طالب على حدة.</li></ul></div>
                        </div>
                            <div class="grant-card">
                            <h3>👨‍👧‍👦 منحة الأسرة (4 أشقاء فأكثر) <span class="grant-percentage">30%</span></h3>
                            <div class="grant-details"><ul><li>للاستمرارية: معدل 70% (75% للطب)</li><li>لكل طالب على حدة.</li></ul></div>
                        </div>
                        <div class="grant-card">
                            <h3>💼 منحة أبناء العاملين <span class="grant-percentage">50%</span></h3>
                            <div class="grant-details"><ul><li>للاستمرارية: معدل فصلي 65%</li><li>تشمل أبناء العاملين ومجلس الأمناء.</li></ul></div>
                        </div>
                            <div class="grant-card">
                            <h3>❤️ منح الأسرى والشهداء والأيتام <span class="grant-percentage">70%+</span></h3>
                            <div class="grant-details"><ul><li>للاستمرارية: معدل فصلي 80%</li><li>تتوفر منح مختلفة لهذه الفئات وتتطلب إثباتات رسمية.</li></ul></div>
                        </div>
                    </div>

                    <div class="info-footer">
                        <button id="start-grants-quiz-btn" class="action-button">
                            فهمت... ابدأ التحدي الآن!
                            <span class="btn-icon">💡</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="grants-scene" class="game-stage hidden"></div>
            
            <div id="exchange-info-scene" class="game-stage hidden">
                <div class="scene-content">
                    <div class="info-header">
                        <h2 class="scene-title">🌍 دليل التبادل الأكاديمي</h2>
                        <p>تهتم العلاقات الخارجية بتوفير فرص تبادل أكاديمي مميزة. تعرّف على هذه الفرص قبل أن تبدأ التحدي.</p>
                    </div>
                    <div class="info-scene-container">
                        <div class="exchange-card">
                            <h3>برامج التبادل الرئيسية</h3>
                            <div class="exchange-details">
                                <ul>
                                    <li>تهدف إلى التبادل الثقافي ونقل الخبرات لتحسين القدرات المؤسسية.</li>
                                    <li>تشمل برامج البكالوريوس، الماجستير، الدكتوراه، وما بعد الدكتوراه.</li>
                                    <li>تُنفذ بالشراكة مع جامعات في أوروبا، تركيا، وماليزيا.</li>
                                </ul>
                            </div>
                        </div>
                        <h3 class="exchange-category">أشهر برامج التبادل</h3>
                        <div class="exchange-card">
                            <h3>Erasmus Mundus <span class="exchange-project">مشاريع تبادل</span></h3>
                            <div class="exchange-details">
                                <ul>
                                    <li>حصلت الجامعة على تمويل لـ 6 مشاريع.</li>
                                    <li>بالشراكة مع 70 جامعة محلية وإقليمية ودولية.</li>
                                    <li>تم تنفيذها خلال الفترة من 2012 وحتى 2017.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="exchange-card">
                            <h3>Erasmus+ <span class="exchange-project">حراك علمي</span></h3>
                            <div class="exchange-details">
                                <ul>
                                    <li>شاركت الجامعة بأكثر من 12 مشروعاً.</li>
                                    <li>مشاريع التبادل الأكاديمي خلال الفترة من 2016-2019.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="exchange-card">
                            <h3>Mevlana <span class="exchange-project">برنامج تركي</span></h3>
                            <div class="exchange-details">
                                <ul>
                                    <li>برنامج التبادل الثقافي التركي.</li>
                                    <li>تمت المشاركة مع 6 جامعات تركية.</li>
                                    <li>تم تنفيذه خلال الفترة من 2013-2021.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="info-footer">
                        <button id="start-exchange-quiz-btn" class="action-button">
                            فهمت... ابدأ التحدي الآن!
                            <span class="btn-icon">💡</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="studentaffairs-info-scene" class="game-stage hidden">
                <div class="scene-content">
                       <div class="info-header">
                        <img src="logo-1.png" alt="شعار عمادة شؤون الطلبة" style="max-width: 120px; margin: 0 auto 15px; border-radius: 50%;">
                        <h2 class="scene-title" style="margin-bottom: 10px;">🧑‍🎓 عمادة شؤون الطلبة</h2>
                        <p>رفيقك الدائم خلال رحلتك الجامعية نحو التميز والإبداع.</p>
                    </div>
                    <div id="studentaffairs-info-container">
                        </div>
                    <div class="info-footer">
                        <button id="start-studentaffairs-quiz-btn" class="action-button">
                            فهمت... ابدأ تحدي شؤون الطلبة!
                            <span class="btn-icon">✅</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="studentaffairs-scene" class="game-stage hidden"></div>
            <div id="studentaffairs_tf_questions-scene" class="game-stage hidden"></div>
             <div id="stadium-scene" class="game-stage hidden">
                </div>
            <div id="memory-game-scene" class="game-stage hidden">
                </div>
        

    </div>


    <div id="stadium-scene" class="game-stage hidden">
        </div>
   
        </div>    
            <div id="end-scene" class="game-stage hidden">
                <div class="scene-content">
                    <h2 class="scene-title">🎉 تهانينا! 🎉</h2>
                    <img src="https://placehold.co/400x250/28a745/FFFFFF?text=شهادة+شكر" alt="شهادة مشاركة" class="scene-image" style="max-width: 100%; border-radius: 10px; margin-bottom: 20px;" loading="lazy">
                    <p id="final-message" style="font-size: 18px; line-height: 1.6;"></p>
                    <button id="share-btn" class="action-button">مشاركة على وسائل التواصل</button>
                    <button id="new-player-btn" class="action-button" style="margin-top: 10px; background-color: var(--text-light);">بدء رحلة جديدة (لاعب جديد)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="feedback-modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <div id="modal-text"></div>
            <button id="modal-close-btn" class="action-button">متابعة</button>
        </div>
    </div>
    
    <div id="badge-modal" class="modal hidden">
        <div class="modal-content badge-popup">
            <span class="badge-icon"></span>
            <h3>🎉 شارة جديدة! 🎉</h3>
            <p id="badge-name"></p>
            <button id="badge-close-btn" class="action-button" style="width: auto; margin-top: 20px;">حسناً</button>
        </div>
    </div>

    <div id="logout-confirm-modal" class="modal hidden">
        <div class="modal-content">
            <h2>تأكيد الخروج</h2>
            <p>هل أنت متأكد أنك تريد بدء رحلة جديدة؟ سيتم حذف كل تقدمك الحالي.</p>
            <div class="modal-actions">
                <button id="confirm-logout-btn" class="action-button danger">نعم، اخرج</button>
                <button id="cancel-logout-btn" class="action-button secondary">لا، ابقَ هنا</button>
            </div>
        </div>
    </div>

    <div id="ad-modal" class="modal hidden">
        <div class="ad-modal-content">
            <span class="close-ad-btn">&times;</span>
            <img src="eng.webp" alt="إعلان كلية الهندسة" loading="lazy">
        </div>
    </div>

    <div id="video-overlay" class="modal hidden">
        <video id="welcome-video" width="90%" style="max-width: 800px; border-radius: 15px;" preload="auto">
            <source src="hares 1.mp4" type="video/mp4">
            متصفحك لا يدعم عرض الفيديو.
        </video>
        <button id="skip-video-btn" class="action-button">تخطي الفيديو</button>
    </div>
 <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby2RjbdyISPTbhfR8h-lE41eY0lEWEOxZevGyTMxNbpY2zTmRzWa3DEAd5Dc6O72GgtMA/exec';
    
    const form = document.getElementById('player-form');
    if(form){
        const startBtn = form.querySelector('button');
        const inputs = form.querySelectorAll('input[required]');
        form.addEventListener('input', () => {
            startBtn.disabled = !form.checkValidity();
        });
    }

    function registerPlayer(name, phone, year) {
        const formData = new FormData();
        formData.append('action', 'register');
        formData.append('name', name);
        formData.append('phone', phone);
        formData.append('year', year);
        return fetch(SCRIPT_URL, { method: 'POST', body: formData }).then(response => response.json());
    }
    
    function updatePlayerScore(uniqueId, score) {
        if (!uniqueId) {
            console.error("Attempted to update score without a uniqueId.");
            return;
        }
        const formData = new FormData();
        formData.append('action', 'updateScore');
        formData.append('uniqueId', uniqueId);
        formData.append('score', score);
        fetch(SCRIPT_URL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    console.log(`Score updated to: ${score}`);
                } else {
                    console.error('Error updating score:', data.message);
                }
            })
            .catch(error => console.error('Error in update fetch:', error));
    }

    function shuffleArray(array) {
        let currentIndex = array.length, randomIndex;
        const newArray = [...array]; 
        
        while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [newArray[currentIndex], newArray[randomIndex]] = [
                newArray[randomIndex], newArray[currentIndex]
            ];
        }
        return newArray;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const collegesData = [
            { name: 'كلية الطب', description: 'الطب وعلومه وطبيبٌ للمستقبل', url: 'https://medicine.iugaza.edu.ps/', emoji: '⚕️' },
            { name: 'كلية الهندسة', description: 'هندسة المستقبل بكافة مجالات الحياة', url: 'https://eng.iugaza.edu.ps/', emoji: '🏗️' },
            { name: 'كلية تكنولوجيا المعلومات', description: 'عصر التكنولوجيا والمعلوماتية وأمن المعلومات والبيانات', url: 'https://fit.iugaza.edu.ps/', emoji: '💻' },
            { name: 'كلية التمريض', description: 'بذلٌ وعطاءٌ وتفانٍ لكل مريض وفي كل مكان', url: 'https://nursing.iugaza.edu.ps/', emoji: '🩺' },
            { name: 'كلية العلوم الصحية', description: 'العلاج السليم يبدأ من هنا', url: 'https://healthscience.iugaza.edu.ps/', emoji: '🧬' },
            { name: 'كلية العلوم', description: 'علوم الطبيعة وأسرار الكون', url: 'https://science.iugaza.edu.ps/', emoji: '🔬' },
            { name: 'كلية الآداب', description: 'علمٌ ولغاتٌ وأدبٌ وثقافة الأمم المختلفة قديماً وحديثاً', url: 'https://arts.iugaza.edu.ps/', emoji: '📚' },
            { name: 'كلية الشريعة والقانون', description: 'دراسة للشريعة الاسلامية والمحاماة على مبادئ الشريعة السمحة', url: 'https://sharea.iugaza.edu.ps/', emoji: '⚖️' },
            { name: 'كلية أصول الدين', description: 'الدين الإسلامي ، أصوله وأحكامه', url: 'https://osool.iugaza.edu.ps/', emoji: '🕌' },
            { name: 'كلية التربية', description: 'معلمٌ .. يربي أجيال المستقبل المستنيرة', url: 'https://education.iugaza.edu.ps/', emoji: '👩‍🏫' },
            { name: 'كلية الاقتصاد والعلوم الإدارية', description: 'بناء الاقتصاد والإدارة السليمة والمال', url: 'https://commerce.iugaza.edu.ps/', emoji: '💼' }
        ];

        const allGuides = [
            { id: 'medicine', name: 'د. خالد', gender: 'male', college: 'كلية الطب', emoji: '⚕️', description: 'الدقة والتشخيص السليم هما مفتاح النجاح. سأرشدك في رحلة معرفية صحية.' },
            { id: 'engineering', name: 'م. سارة', gender: 'female', college: 'كلية الهندسة', emoji: '🏗️', description: 'كل مشروع عظيم يبدأ بتصميم دقيق. لنبني مستقبلك خطوة بخطوة.' },
            { id: 'it', name: 'مبرمج بدر', gender: 'male', college: 'كلية تكنولوجيا المعلومات', emoji: '💻', description: 'في عالم الأكواد، كل مشكلة لها حل. سأساعدك على التفكير بمنطقية وإيجاد الحلول.' },
            { id: 'nursing', name: 'ممرضة أمل', gender: 'female', college: 'كلية التمريض', emoji: '🩺', description: 'الرحمة والعناية هما أساس مهنتنا. سأكون بجانبك لألهمك العطاء.' },
            { id: 'health_sciences', name: 'أخصائي رامي', gender: 'male', college: 'كلية العلوم الصحية', emoji: '🧬', description: 'صحة المجتمع تبدأ من المختبر. معًا سنكتشف أسرار الوقاية والعلاج.' },
            { id: 'sciences', name: 'عالمة نور', gender: 'female', college: 'كلية العلوم', emoji: '🔬', description: 'الكون مليء بالأسئلة، والعلوم هي وسيلتنا للإجابة. دعنا نستكشف بشغف.' },
            { id: 'arts', name: 'أديبة ليلى', gender: 'female', college: 'كلية الآداب', emoji: '📚', description: 'الكلمات تبني الحضارات. سأجعل رحلتك مليئة بالإبداع والمعاني الجميلة.' },
            { id: 'law', name: 'فقيه يوسف', gender: 'male', college: 'كلية الشريعة والقانون', emoji: '⚖️', description: 'العدل هو أساس الملك. سأعلمك كيف توازن بين الحقوق والواجبات.' },
            { id: 'religion', name: 'داعية إيمان', gender: 'female', college: 'كلية أصول الدين', emoji: '🕌', description: 'العلم بالدين ينير الدرب. سأرافقك في رحلة لفهم مقاصد شريعتنا السمحة.' },
            { id: 'education', name: 'أستاذة هدى', gender: 'female', college: 'كلية التربية', emoji: '👩‍🏫', description: 'بناء الأجيال هو أسمى الرسالات. معًا سنتعلم كيف نلهم العقول ونبني المستقبل.' },
            { id: 'economics', name: 'خبير مالي', gender: 'male', college: 'كلية الاقتصاد', emoji: '💼', description: 'فهم المال والاقتصاد هو مفتاح بناء مستقبل مزدهر. دعنا نخطط لنجاحك.' }
        ];

        const guideMessages = {
            'gate': {
                medicine: "مرحباً بك! الدخول للجامعة يشبه التشخيص الأول، يجب أن يكون دقيقاً. ركز جيداً.",
                engineering: "أهلاً بك. هذه البوابة هي أساس مشروعك التعليمي. لنبدأ ببناء متين!",
                it: "مصادقة ناجحة! لقد تجاوزت جدار الحماية الأول. أهلاً بك في نظام الجامعة.",
                nursing: "تماماً مثل استقبال المريض، نرحب بك بحرارة. رحلتك نحو العطاء تبدأ الآن.",
                health_sciences: "العينة الأولى هي سؤال الدخول! حلله بعناية لتكشف الإجابة الصحيحة.",
                sciences: "مرحباً أيها الباحث! كل اكتشاف عظيم يبدأ بفرضية. ما هي فرضيتك للإجابة الصحيحة؟",
                arts: "لكل قصة بداية، وهذه بداية قصتك الجامعية. اجعلها بداية مُلهمة.",
                law: "قبل الدخول، يجب التأكد من استيفاء الشروط. هل أنت مستعد لإثبات جدارتك؟",
                religion: "بسم الله نبدأ. هذه البوابة هي مدخلك إلى صرح من صروح العلم والإيمان.",
                education: "أهلاً بك في الفصل الأول من رحلتك. كل إجابة صحيحة هي خطوة نحو إلهام الآخرين.",
                economics: "هذه أول صفقة لك! استثمر تركيزك جيداً لتحقيق أول ربح في رصيدك."
            },
            'library': {
                medicine: "المكتبة هي مصدر الأبحاث الطبية الحديثة. كل كتاب هنا قد ينقذ حياة في المستقبل.",
                engineering: "هنا تجد المخططات والمراجع لبناء أي شيء تتخيله. المعرفة هي أقوى مواد البناء.",
                it: "المكتبة هي قاعدة بياناتنا الضخمة. ابحث جيداً وستجد الخوارزمية الصحيحة لحل أي تحدٍ.",
                nursing: "كما نحتاج للمراجع لمعرفة أفضل طرق الرعاية، ستجد هنا كل ما تحتاجه لتغذية عقلك.",
                health_sciences: "نتائج أبحاثنا تعتمد على دقة مصادرنا. المكتبة هي مختبرك النظري الأول.",
                sciences: "هنا تجد أبحاث من سبقونا. قف على أكتاف العمالقة لترى أبعد.",
                arts: "الكتب هي غذاء الروح. استلهم من قصص العظماء هنا لتكتب قصتك الخاصة.",
                law: "هنا تجد نصوص القوانين والسوابق القضائية. كل قضية ناجحة تبدأ ببحث دقيق.",
                religion: "هذه رياض من رياض الجنة. هنا كتب التفسير والحديث التي تنير العقل والقلب.",
                education: "المكتبة هي مصدر إعداد الدروس للمستقبل. كلما قرأت أكثر، زادت قدرتك على التعليم.",
                economics: "هنا تجد نظريات كبار الاقتصاديين. دراسة الماضي هي أفضل طريقة للتنبؤ بالمستقبل."
            },
            'faculties-list': {
                medicine: "ستجد كلية الطب هنا، حيث نتعلم كيف ننقذ الأرواح. اختر بحكمة وشغف.",
                engineering: "هذه منطقة الكليات، وكليتي (الهندسة) هنا! كل مبنى يحمل معرفة مختلفة. استكشف بشغف.",
                it: "هذه هي الشبكة الرئيسية للكليات. كل كلية تمثل خادماً (Server) للمعرفة. إلى أي واحد ستتصل؟",
                nursing: "هنا تتوزع أقسام المستشفى التعليمي... عفواً، أقصد كليات الجامعة. كل كلية تقدم نوعاً فريداً من الرعاية.",
                health_sciences: "كل كلية هنا تختص بمجال حيوي. استكشفها لتجد المجال الذي يثير شغفك.",
                sciences: "هذه الكليات تمثل فروع شجرة المعرفة. أي فرع ستختار لتتسلقه؟",
                arts: "كل كلية هنا تمثل فصلاً في كتاب الجامعة الكبير. أي فصل ستختار أن تقرأ؟",
                law: "أمامك هيئات تشريعية مختلفة للمعرفة. اختر الهيئة التي ستنتمي إليها.",
                religion: "كل كلية هنا هي منبر علم. اختر المنبر الذي ستنهل منه العلم الشرعي.",
                education: "هذه هي الفصول الدراسية للجامعة. اختر الفصل الذي ستتعلم فيه لكي تُعلِّم.",
                economics: "هذه هي أسواق المعرفة المختلفة. كل كلية لها أصولها وقيمتها. استثمر في مستقبلك."
            },
            'studentaffairs-info': {
                medicine: "صحة الطالب النفسية والاجتماعية جزء لا يتجزأ من نجاحه. شؤون الطلبة هي 'الطبيب' الذي يعالج أي مشكلة تواجهك.",
                engineering: "كما تحتاج المشاريع الكبرى إلى إدارة وإشراف، تحتاج رحلتك الجامعية إلى دعم. شؤون الطلبة هي الجهة المشرفة.",
                it: "شؤون الطلبة هي 'نظام الدعم الفني' لك. مهما كانت المشكلة، لديهم حل أو توجيه.",
                nursing: "هنا تجد الرعاية والدعم. عمادة شؤون الطلبة هي قلب الجامعة الذي يهتم بكل طالب.",
                health_sciences: "تحليل المشكلات الطلابية وإيجاد حلول لها هو تخصصهم. لا تتردد في استشارتهم.",
                sciences: "هم يدرسون 'الظواهر' الطلابية ويضعون الحلول. استكشف الخدمات التي يقدمونها لك.",
                arts: "هنا يتم نسج قصص النجاح الطلابية ودعم المواهب. شؤون الطلبة هي منصة إبداعك.",
                law: "هم يضمنون حقوقك كطالب ويوجهونك لواجباتك. تعرف على 'قوانين' الدعم الطلابي.",
                religion: "الإرشاد والتوجيه السليم من أهم مهامهم، استعن بهم لتكون رحلتك مباركة.",
                education: "هم 'المعلمون' الذين يرشدونك خارج القاعة الدراسية، ويساعدونك على تنمية مهاراتك.",
                economics: "يديرون 'محفظة' المنح والقروض لمساعدتك. استثمر وقتك في التعرف على خدماتهم المالية."
            }
        };

        const gameData = {
            'gate': { id: 'gate_q1', image: 'hares 1.webp', question: 'أهلاً بك في الجامعة الإسلامية! للدخول، أجب عن السؤال التالي: في أي عام تأسست الجامعة؟', options: { '1978': '1978', '1982': '1982', '1960': '1960', '1990': '1990' }, correctAnswer: '1978', points: 1, 
                hint: { default: "التاريخ قريب من نهاية السبعينيات." },
                correctFeedback: { default: 'رائع! لقد حصلت على نقطة واحدة. البوابة الآن مفتوحة أمامك!' },
                incorrectFeedback: { default: 'إجابة غير صحيحة. حاول مرة أخرى!' }
            },
            'library': [ { id: 'library_q1', image: 'library_question.webp', question: 'تضم مكتبتنا كنزاً معرفياً ضخماً. كم عدد المراجع الإلكترونية التي توفرها؟', options: { '100k': 'أكثر من 100 ألف مرجع الكتروني', '150k': 'أكثر من 150 ألف مرجع الكتروني', '50k': 'أقل من 50 ألف مرجع الكتروني', '200k': 'أكثر من 200 ألف مرجع الكتروني' }, correctAnswer: '150k', points: 1, 
                hint: { it: "قواعد البيانات لدينا واسعة جداً، فكر في رقم كبير لكنه ليس الأكبر في الخيارات." },
                correctFeedback: { default: 'إجابة ممتازة! معرفتك دقيقة. لقد ربحت نقطة واحدة.' },
                incorrectFeedback: { default: 'المعرفة قوة، حاول مرة أخرى!' } 
            }, { id: 'library_q2', image: 'library_question_2.webp', question: 'هل توفر المكتبة قاعات هادئة ومخصصة للدراسة؟', options: { 'yes': 'نعم، توفر قاعات هادئة', 'no': 'لا، المكتبة للكتب فقط' }, correctAnswer: 'yes', points: 1, 
                hint: { education: "بيئة التعلم المناسبة ضرورية، والجامعة تهتم بذلك." },
                correctFeedback: { default: 'بالتأكيد! راحتك أثناء الدراسة تهمنا. لقد ربحت نقطة واحدة إضافية.' },
                incorrectFeedback: { default: 'إجابة غير صحيحة. المكتبة مكان مثالي للدراسة.' } 
            }, { id: 'library_q3', image: 'library_question_3.webp', question: 'كيف تساعدك المكتبة في أبحاثك الجامعية؟', options: { 'resources': 'توفر مصادر ومراجع متنوعة', 'writes_for_you': 'تكتب البحث بدلاً عنك' }, correctAnswer: 'resources', points: 1, 
                hint: { sciences: "البحث العلمي يعتمد على الاستشهاد بمصادر موثوقة." },
                correctFeedback: { default: 'صحيح! المكتبة هي شريكك الأول في البحث العلمي. ربحت نقطة واحدة.' },
                incorrectFeedback: { default: 'إجابة غير دقيقة. المكتبة تدعمك بالمصادر لا بالقيام بالعمل عنك.' } 
            }, { id: 'library_q4', image: 'library_question_4.webp', question: 'هل توفر المكتبة مواد رقمية يمكن الوصول إليها عن بعد؟', options: { 'yes_ebooks': 'نعم، توفر كتباً إلكترونية', 'no_digital': 'لا، كل المواد ورقية فقط' }, correctAnswer: 'yes_ebooks', points: 1, 
                hint: { it: "نحن في عصر التحول الرقمي، والجامعة تواكب ذلك." },
                correctFeedback: { default: 'أحسنت! يمكنك الوصول لكنز معرفي من أي مكان. لقد ربحت آخر نقطة في هذه المرحلة.' },
                incorrectFeedback: { default: 'إجابة غير صحيحة. العصر الرقمي في قلب مكتبتنا.' } 
            } ],
            'faculties-list': { isInfoScreen: true, nextScene: 'faculties' },
            'faculties': { id: 'faculties_menu', image: 'first_faculties_q.webp', question: 'اختر نوع التحدي الذي تود خوضه هنا:', options: { 'tf_questions': '<span class="icon">✔️❌</span> أسئلة صح وخطأ', 'mc_questions': '<span class="icon">❓</span> أسئلة اختيار من متعدد' }, correctAnswer: null, points: 0, nextScene: { 'tf_questions': 'tf_questions', 'mc_questions': 'mc_questions' } },
            'tf_questions': [ { id: 'tf_q1', image: 'all_q.webp', question: 'تأسست الجامعة الإسلامية بغزة عام 1978.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint:{default: "هذا السؤال يشبه سؤال البوابة، هل تتذكره?"} }, { id: 'tf_q2', image: 'all_q.webp', question: 'الجامعة لديها 11 كلية.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint:{default: "قمنا بعدّ الكليات في شاشة استكشاف الكليات، العدد فردي."} }, { id: 'tf_q3', image: 'all_q.webp', question: 'كلية الطب تأسست عام 2006.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint:{medicine: "تاريخ تأسيس كليتي حديث نسبياً."} }, { id: 'tf_q4', image: 'all_q.webp', question: 'كلية تكنولوجيا المعلومات أُسست قبل كلية التجارة.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'incorrect', points: 1, hint: {economics: "كلية التجارة (الاقتصاد) من الكليات القديمة في الجامعة."} }, { id: 'tf_q5', image: 'all_q.webp', question: 'الجامعة تقدم شهادات دكتوراة (PhD) في الإدارة، الاقتصاد، الهندسة، الفنون، وتكنولوجيا المعلومات.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint: {default: "الجامعة تقدم برامج دراسات عليا متقدمة في معظم كلياتها الرئيسية."} }, { id: 'tf_q6', image: 'all_q.webp', question: 'الجامعة الأولى على مستوى غزة من حيث الترتيب العالمي.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint: {default: "الجامعة تفتخر بتصنيفها المتقدم."} }, { id: 'tf_q7', image: 'all_q.webp', question: 'في كلية الطب، يجب على الطالب نشر بحث علمي في مجلة محكّمة كجزء من متطلبات التخرج.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint: {medicine: "البحث العلمي جزء أساسي من تكوين الطبيب الناجح."} }, { id: 'tf_q8', image: 'all_q.webp', question: 'كلية الطب هي المركز الوحيد المعتمد لإجراء امتحانات IFOM داخل غزة.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint: {medicine: "هذا الامتحان الدولي مهم لتقييم العلوم الطبية الأساسية والسريرية."} }, { id: 'tf_q9', image: 'all_q.webp', question: 'الجامعة مقرها فقط في مدينة غزة، ولا يوجد لها فروع أخرى.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'incorrect', points: 1, hint: {default: "هل تصل خدمات الجامعة التعليمية إلى مناطق أخرى في القطاع؟"} }, { id: 'tf_q10', image: 'all_q.webp', question: 'الجامعة عضو في الاتحاد الدولي للجامعات ومجموعة جامعات البحر الأبيض المتوسط.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint: {default: "الانتماء لهذه الاتحادات يعزز من مكانة الجامعة العالمية."} } ],
            'mc_questions': [ { id: 'mc_q1', image: 'all_q.webp', question: 'كم عدد الكليات في الجامعة الإسلامية بغزة؟', options: { '11': '11', '9': '9', '10': '10', '12': '12' }, correctAnswer: '11', points: 1, hint:{default: "الرقم فردي وأكبر من 10."} }, { id: 'mc_q2', image: 'all_q.webp', question: 'أي من الكليات التالية ليست من كليات الجامعة؟', options: { 'it': 'تكنولوجيا المعلومات', 'الفنون': 'الفنون', 'الطب': 'الطب', 'الهندسة': 'الهندسة' }, correctAnswer: 'الفنون', points: 1, hint:{arts: "كليتي هي 'الآداب'، وهي تختلف عن الفنون الجميلة."} }, { id: 'mc_q3', image: 'all_q.webp', question: 'متى تأسست كلية الطب بالجامعة؟', options: { '2006': '2006', '1980': '1980', '1993': '1993', '2005': '2005' }, correctAnswer: '2006', points: 1, hint:{default: "كان ذلك في منتصف العقد الأول من الألفية الجديدة."} }, { id: 'mc_q4', image: 'all_q.webp', question: 'أي من التالي يصف مكانة الجامعة على مستوى غزة؟', options: { 'الأولى': 'الأولى', 'الثالثة': 'الثالثة', 'الرابعة': 'الرابعة', 'الثانية': 'الثانية' }, correctAnswer: 'الأولى', points: 1, hint: {default: "الجامعة رائدة في قطاع غزة."} }, { id: 'mc_q5', image: 'all_q.webp', question: 'في أي كلية يجب على الطالب اجتياز امتحاني IFOM-BSE وIFOM-CSE للتخرج؟', options: { 'الطب': 'الطب', 'الهندسة': 'الهندسة', 'it': 'تكنولوجيا المعلومات', 'التربية': 'التربية' }, correctAnswer: 'الطب', points: 1, hint: {medicine: "هذه امتحانات دولية لقياس الكفاءة الطبية، وهي ضرورية في كليتي."} }, { id: 'mc_q6', image: 'all_q.webp', question: 'من بين هذه الكليات، أيها تأسست أولاً؟', options: { 'التربية (1980)': 'التربية (1980)', 'تكنولوجيا المعلومات (2005)': 'تكنولوجيا المعلومات (2005)', 'التجارة (1981)': 'التجارة (1981)', 'الطب (2006)': 'الطب (2006)' }, correctAnswer: 'التربية (1980)', points: 1, hint: {education: "كليتنا من الكليات المؤسسة للجامعة."} }, { id: 'mc_q7', image: 'all_q.webp', question: 'أي من الاتحادات التالية الجامعة عضو فيها؟', options: { 'اتحاد البحر المتوسط لجامعات': 'اتحاد البحر المتوسط لجامعات', 'رابطة الجامعات الأمريكية': 'رابطة الجامعات الأمريكية', 'روسيا الجامعات الإسلامية': 'روسيا الجامعات الإسلامية', 'رابطة الجامعات الصينية': 'رابطة الجامعات الصينية' }, correctAnswer: 'اتحاد البحر المتوسط لجامعات', points: 1, hint: {default: "موقع فلسطين الجغرافي قد يساعدك في تحديد الإجابة."} }, { id: 'mc_q8', image: 'all_q.webp', question: 'كم عدد المراكز والمعاهد البحثية بالجامعة؟', options: { 'أكثر من 20': 'أكثر من 20', 'أقل من 10': 'أقل من 10', 'حوالي 15': 'حوالي 15', '30 فقط': '30 فقط' }, correctAnswer: 'أكثر من 20', points: 1, hint: {sciences: "البحث العلمي أولوية، لذا عدد المراكز كبير ويدعم تخصصات مختلفة."} } ],
            'exchange-info': { isInfoScreen: true, nextScene: 'exchange' },
            'exchange': { id: 'exchange_menu', image: 'all_q.webp', question: 'اختر نوع التحدي الذي تود خوضه هنا:', options: { 'exchange_tf_questions': '<span class="icon">✔️❌</span> أسئلة صح وخطأ', 'exchange_mc_questions': '<span class="icon">❓</span> أسئلة اختيار من متعدد' }, correctAnswer: null, points: 0, nextScene: { 'exchange_tf_questions': 'exchange_tf_questions', 'exchange_mc_questions': 'exchange_mc_questions' } },
            'exchange_tf_questions': [ { id: 'ex_tf_q1', image: 'all_q.webp', question: 'تهتم العلاقات الخارجية في الجامعة بتوفير منح بكالوريوس، ماجستير، دكتوراه وما بعد الدكتوراه في جامعات عالمية.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint:{default:"هل تهدف الجامعة لربط طلابها بالعالم؟"} }, { id: 'ex_tf_q2', image: 'all_q.webp', question: 'الجامعة عضو في شبكة جامعات البحر الأسود وشرق البحر المتوسط (BSEMAN).', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint:{arts: "الانفتاح على ثقافات وحضارات مختلفة هو من أهدافنا."} }, { id: 'ex_tf_q3', image: 'all_q.webp', question: 'العلاقات الخارجية أبرمت مشاريع تبادل أكاديمي ضمن برنامج Erasmus+ مع جامعة جلاسكو وجامعة Algarve.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint:{default: "برنامج إيراسموس هو برنامج تبادل طلابي أوروبي شهير."} } ],
            'exchange_mc_questions': [ { id: 'ex_mc_q1', image: 'all_q.webp', question: 'أياً من الخدمات التالية تتولّاها دائرة العلاقات الخارجية؟', options: { 'توفير منح دراسية دولية والتبادل الأكاديمي واستقطاب الباحثين': 'توفير منح دراسية دولية والتبادل الأكاديمي واستقطاب الباحثين', 'تأمين المنح الدراسية فقط': 'تأمين المنح الدراسية فقط', 'تنظيم الرحلات السياحية': 'تنظيم الرحلات السياحية', 'إصدار التراخيص الحكومية': 'إصدار التراخيص الحكومية' }, correctAnswer: 'توفير منح دراسية دولية والتبادل الأكاديمي واستقطاب الباحثين', points: 1, hint:{default: "ابحث عن الإجابة الأكثر شمولاً وتخصصاً."} }, { id: 'ex_mc_q2', image: 'all_q.webp', question: 'ما البرنامج الأوروبي الذي فتح المجال لتبادل أعضاء هيئة التدريس والطلبة؟', options: { 'Erasmus+ (Key Action 1)': 'Erasmus+ (Key Action 1)', 'Horizon 2020': 'Horizon 2020', 'Marie Skłodowska-Curie': 'Marie Skłodowska-Curie', 'Erasmus Mundus': 'Erasmus Mundus' }, correctAnswer: 'Erasmus+ (Key Action 1)', points: 1, hint:{default: "إيراسموس هو الاسم الأكثر شهرة في برامج التبادل الأوروبية."} }, { id: 'ex_mc_q3', image: 'all_q.webp', question: 'أيٌّ مما يلي ليس من اختصاص العلاقات الخارجية بحسب الموقع؟', options: { 'قبول طلبات القبول الجامعي المحلي': 'قبول طلبات القبول الجامعي المحلي', 'برامج التعاون الأكاديمي': 'برامج التعاون الأكاديمي', 'التبادل الأكاديمي': 'التبادل الأكاديمي', 'بوابة الباحثين عن منح': 'بوابة الباحثين عن منح' }, correctAnswer: 'قبول طلبات القبول الجامعي المحلي', points: 1, hint:{default: "هناك عمادة أخرى مختصة بالقبول المحلي."} } ],
            'grants-info': { isInfoScreen: true, nextScene: 'grants' },
            'grants': [ { id: 'grants_q1', image: 'all_q.webp', question: 'أنهت مريم فصلها الدراسي الأول في كلية الهندسة بتفوق، وحصلت على معدل فصلي 96% بعد أن درست 16 ساعة معتمدة. ما هي نسبة "منحة الامتياز" التي تستحقها تلقائياً في الفصل التالي؟', options: { '35': '35%', '50': '50%', '70': '70%', '100': '100%' }, correctAnswer: '70', points: 1, hint:{economics:"التميز العالي يكافأ بأعلى نسبة منحة تفوق متاحة (70% للمعدل فوق 95%)."} }, { id: 'grants_q2', image: 'all_q.webp', question: 'ما هي نسبة "منحة الأسرة" التي يحصل عليها كل فرد من أسرة لديها "شقيقان فقط" يدرسان في الجامعة؟', options: { '15': '15%', '25': '25%', '30': '30%', '50': '50%' }, correctAnswer: '15', points: 1, hint:{default:"هي النسبة الأقل في منحة الأسرة."} }, { id: 'grants_q3', image: 'all_q.webp', question: 'إذا كان معدل أحد الأشقاء في كلية الطب 72%، هل يستمر في الاستفادة منحة الأسرة؟', options: { 'yes_continue': 'نعم، ستستمر', 'no_stop': 'لا، ستتوقف' }, correctAnswer: 'no_stop', points: 1, hint:{medicine:"للاستمرارية في المنحة، يجب أن يكون معدل طالب الطب 75% فما فوق."} }, { id: 'grants_q4', image: 'all_q.webp', question: 'ما هي نسبة المنحة التي يحصل عليها الطالب الذي يحفظ القرآن الكريم كاملاً بعد اجتياز امتحان التسميع؟', options: { '35': '35%', '50': '50%', '70': '70%', '100': '100%' }, correctAnswer: '50', points: 1, hint:{religion:"الجامعة تقدر حفظة كتاب الله وتمنحهم نصف الرسوم."} } ],
            'admission-info': { isInfoScreen: true, nextScene: 'admission' },
            'admission': { id: 'admission_menu', image: 'all_q.webp', question: 'اختر نوع التحدي الذي تود خوضه هنا:', options: { 'admission_tf_questions': '<span class="icon">✔️❌</span> أسئلة صح وخطأ', 'admission_mc_questions': '<span class="icon">❓</span> أسئلة اختيار من متعدد' }, correctAnswer: null, points: 0, nextScene: { 'admission_tf_questions': 'admission_tf_questions', 'admission_mc_questions': 'admission_mc_questions' } },
            'admission_tf_questions': [ { id: 'ad_tf_q1', image: 'all_q.webp', question: 'معدل القبول في كلية الطب البشري هو 96%.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'incorrect', points: 1, hint:{medicine: "القبول في كليتي يتطلب أعلى معدل على الإطلاق، وهو أعلى من هذا الرقم بقليل."} }, { id: 'ad_tf_q2', image: 'all_q.webp', question: 'يمكن لطلبة الفرع الأدبي الالتحاق بكلية التمريض.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint:{nursing:"نعم، ولكن بمعدل قبول أعلى من الفرع العلمي."} }, { id: 'ad_tf_q3', image: 'all_q.webp', question: 'كلية العلوم الصحية لا تقبل طلبة من الفرع الأدبي.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint:{health_sciences:"تخصصاتنا تتطلب أساساً علمياً قوياً."} } ],
            'admission_mc_questions': [ { id: 'ad_mc_q1', image: 'all_q.webp', question: 'ما هو معدل القبول المطلوب للالتحاق بتخصص "الذكاء الاصطناعي"؟', options: { '80': '80%', '65': '65%', '70': '70%', '75': '75%' }, correctAnswer: '80', points: 1, hint:{it:"الذكاء الاصطناعي هو تخصص هندسي، ومعدلات الهندسة تبدأ من هذا الرقم."} }, { id: 'ad_mc_q2', image: 'all_q.webp', question: 'أي كلية تتطلب أعلى معدل قبول للفرع العلمي؟', options: { 'الهندسة': 'الهندسة', 'الطب': 'الطب', 'تكنولوجيا المعلومات': 'تكنولوجيا المعلومات', 'العلوم': 'العلوم' }, correctAnswer: 'الطب', points: 1, hint:{medicine:"كليتي تتطلب أعلى معدل قبول في الجامعة."} }, { id: 'ad_mc_q3', image: 'all_q.webp', question: 'ما هو أدنى معدل قبول يمكن للطالب الحاصل على شهادة الثانوية العامة (الفرع العلمي) الالتحاق به في الجامعة؟', options: { '65': '65%', '70': '70%', '75': '75%', '60': '60%' }, correctAnswer: '65', points: 1, hint:{default:"هذا المعدل يفتح لك أبواب العديد من الكليات مثل العلوم وتكنولوجيا المعلومات."} } ],
            'studentaffairs-info': { isInfoScreen: true, nextScene: 'studentaffairs' },
            'studentaffairs': { id: 'studentaffairs_menu', image: 'all_q.webp', question: 'أنت الآن في محطة شؤون الطلبة، اختر نوع التحدي:', options: { 'studentaffairs_tf_questions': '<span class="icon">✔️❌</span> أسئلة صح وخطأ', 'studentaffairs_mc_questions': '<span class="icon">❓</span> أسئلة اختيار من متعدد' }, correctAnswer: null, points: 0, nextScene: { 'studentaffairs_tf_questions': 'studentaffairs_tf_questions', 'studentaffairs_mc_questions': 'studentaffairs_mc_questions' } },
            'studentaffairs_tf_questions': [
                { id: 'sa_tf_q1', image: 'all_q.webp', question: 'تأسست عمادة شؤون الطلبة في نفس عام تأسيس الجامعة.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'incorrect', points: 1, hint: { default: 'الجامعة تأسست عام 1978، لكن العمادة تأسست بعد ذلك ببضع سنوات قليلة.' }, correctFeedback: { default: 'إجابة صحيحة! تأسست العمادة عام 1981م.' } },
                { id: 'sa_tf_q2', image: 'all_q.webp', question: 'من مهام عمادة شؤون الطلبة الإشراف على النشاط الثقافي والرياضي.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint: { default: 'الأنشطة اللامنهجية هي جزء أساسي من عمل العمادة.' } },
                { id: 'sa_tf_q3', image: 'all_q.webp', question: 'قسم البحث الاجتماعي هو المسؤول عن ترشيح الطلبة للمنح الخارجية.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint: { economics: 'الحالة المادية للطالب عامل مهم في تحديد استحقاقه للمنح، وهذا القسم يدرس ذلك.' } },
                { id: 'sa_tf_q4', image: 'all_q.webp', question: 'العمل التطوعي هو مساق اختياري يمكن للطالب التسجيل فيه.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1, hint: { education: 'تشجع الجامعة على خدمة المجتمع، والعمل التطوعي هو أحد أشكال هذه الخدمة.' } }
            ],
            'studentaffairs_mc_questions': [
                { id: 'sa_mc_q1', image: 'all_q.webp', question: 'في أي عام أنشئت عمادة شؤون الطلبة؟', options: { '1978': '1978م', '1981': '1981م', '1990': '1990م', '2000': '2000م' }, correctAnswer: '1981', points: 1, hint: { default: 'كان ذلك بعد 3 سنوات من تأسيس الجامعة.' } },
                { id: 'sa_mc_q2', image: 'all_q.webp', question: 'أي من الأقسام التالية لا يتبع لعمادة شؤون الطلبة؟', options: { 'research': 'البحث الاجتماعي', 'sports': 'النشاط الرياضي', 'guidance': 'التوجيه والإرشاد', 'admission': 'القبول والتسجيل' }, correctAnswer: 'admission', points: 1, hint: { default: 'القبول والتسجيل له عمادة مستقلة ومختصة.' } },
                { id: 'sa_mc_q3', image: 'all_q.webp', question: 'ما هو الهدف من قسم البحث الاجتماعي بشكل أساسي؟', options: { 'academic': 'مساعدة الطلبة أكاديمياً', 'financial': 'مساعدة الطلبة مالياً', 'sports': 'تنظيم الفرق الرياضية', 'cultural': 'إقامة الندوات الثقافية' }, correctAnswer: 'financial', points: 1, hint: { economics: 'يركز القسم على دراسة المشكلات الاقتصادية للطلبة.' } },
                { id: 'sa_mc_q4', image: 'all_q.webp', question: 'ما هي أول خطوة يجب على الطالب اتباعها للاستفادة من خدمات البحث الاجتماعي؟', options: { 'visit': 'زيارة العمادة شخصياً', 'form': 'تعبئة استمارة إلكترونية', 'call': 'الاتصال هاتفياً بالقسم', 'email': 'إرسال بريد إلكتروني' }, correctAnswer: 'form', points: 1, hint: { it: 'تبدأ معظم المعاملات الحديثة بخطوة رقمية.' } }
            ],
            'cafeteria': { isUnderConstruction: true },
            'hospital': { isUnderConstruction: true },
            'conference': { isUnderConstruction: true },
            'stadium': { isUnderConstruction: false }
        };

        const badgesData = [
            { id: 'library-expert', name: 'شارة المثقف', emoji: '🏅', stageId: 'library' },
            { id: 'faculties-expert', name: 'شارة الخبير الهندسي', emoji: '🏅', stageId: 'faculties' },
            { id: 'speed-runner', name: 'شارة البرق', emoji: '⚡', stageId: 'any-timed-stage' },
            { id: 'grants-master', name: 'شارة المنح', emoji: '✨', stageId: 'grants' },
            { id: 'exchange-master', name: 'شارة الجسر', emoji: '🌉', stageId: 'exchange' },
            { id: 'student-affairs-master', name: 'شارة القائد', emoji: '🎯', stageId: 'studentaffairs' },
            { id: 'admission-master', name: 'شارة القبول', emoji: '📝', stageId: 'admission' },
            { id: 'perfect-score', name: 'شارة العلامة الكاملة', emoji: '💯', stageId: 'any-stage-perfect' }
        ];

        const admissionInfoData = [
            { faculty: "الطب", specializations: [ { name: "الطب البشري", score: "97% علمي / 96% طلاب" } ] },
            { faculty: "الهندسة", specializations: [ { name: "الهندسة المدنية، الهندسة المعمارية (تصميم داخلي، تكنولوجيا مباني، تخطيط عمراني)، الذكاء الاصطناعي، هندسة الحاسوب، الهندسة الصناعية، الهندسة الكهربائية، الهندسة البيئية، الهندسة الميكانيكية، هندسة النظم الذكية", score: "80% علمي" } ] },
            { faculty: "تكنولوجيا المعلومات", specializations: [ { name: "علم الحاسوب، تطوير البرمجيات، تكنولوجيا المعلومات، حوسبة الويب (جديد)", score: "65% علمي" }, { name: "الوسائط المتعددة", score: "70% علمي / 65% أدبي" } ] },
            { faculty: "العلوم", specializations: [ { name: "الكيمياء، الرياضيات، الفيزياء، الأحياء، علوم الأرض والبيئة، الكيمياء الحيوية، علوم البحار، الإنتاج النباتي، التكنولوجيا الحيوية، رياضيات فرعي كمبيوتر", score: "65% علمي" } ] },
            { faculty: "العلوم الصحية", specializations: [ { name: "العلوم الطبية المخبرية، البصريات، العلاج الطبيعي، تقنيات التصوير الطبي (جديد)، التغذية السريرية (جديد)", score: "70% علمي" } ] },
            { faculty: "التمريض", specializations: [ { name: "التمريض", score: "70% علمي / 80% أدبي" }, { name: "القبالة", score: "70% علمي / 80% أدبي" } ] },
            { faculty: "الاقتصاد والعلوم الإدارية", specializations: [ { name: "المحاسبة (دراسة باللغة العربية)، إدارة الأعمال (دراسة باللغة العربية)", score: "65% علمي وأدبي" }, { name: "المحاسبة (دراسة باللغة الإنجليزية)، إدارة الأعمال (دراسة باللغة الإنجليزية)", score: "65% علمي وأدبي" }, { name: "إدارة الأعمال فرعي الريادة والإبتكار (جديد)، التسويق والتجارة الالكترونية، العلوم السياسية والإعلام، الاقتصاد والعلوم السياسية، الاقتصاد فرعي الإحصاء التطبيقي، العلوم المالية والمصرفية، المحاسبة فرعي تكنولوجيا المعلومات، الاقتصاد الرقمي وتكنولوجيا المال", score: "65% علمي وأدبي" } ] },
            { faculty: "الشريعة والقانون", specializations: [ { name: "الشريعة الإسلامية", score: "65% علمي وأدبي" }, { name: "الشريعة الإسلامية فرعي فتوى وتحكيم", score: "75% علمي وأدبي" }, { name: "الشريعة والقانون", score: "75% علمي وأدبي" } ] },
            { faculty: "أصول الدين", specializations: [ { name: "أصول الدين (عام)، الدعوة والإعلام", score: "65% علمي وأدبي" } ] },
            { faculty: "الآداب", specializations: [ { name: "اللغة العربية، اللغة العربية فرعي الصحافة، اللغة العربية فرعي التدقيق اللغوي، اللغة الإنجليزية، لغة إنجليزية فرعي ترجمة، لغة إنجليزية فرعي صحافة وإعلام (جديد)، الجغرافيا، الجغرافيا فرعي نظم المعلومات الجغرافية، الصحافة والإعلام، الإعلام الرقمي، الخدمة الاجتماعية، التاريخ والآثار، التاريخ فرعي دراسات إسرائيلية، صحافة وإعلام فرعي تكنولوجيا الإذاعة والتلفزيون", score: "65% علمي وأدبي" } ] },
            { faculty: "التربية", specializations: [ { name: "تعليم اللغة العربية، تعليم اللغة الإنجليزية، تعليم العلوم، تعليم الرياضيات، تعليم اجتماعيات، تعليم التربية الإسلامية، المرحلة الأساسية، الإرشاد النفسي والتوجيه التربوي، الكيمياء وأساليب تدريسها، الفيزياء وأساليب تدريسها، الأحياء وأساليب تدريسها، الحاسوب وأساليب تدريسه، اللغة العربية وأساليب تدريسها، اللغة الإنجليزية وأساليب تدريسها، التاريخ وأساليب تدريسه، الجغرافيا وأساليب تدريسها، الرياضيات وأساليب تدريسها", score: "65% علمي وأدبي" } ] }
        ];

        const gameState = { 
            playerName: '', playerPhone: '', tawjihiYear: '', uniquePlayerId: null, 
            score: 0, currentScene: null, currentSubQuestionIndex: 0, 
            answeredQuestions: new Set(), selectedGuide: null,
            powerUps: {}, 
            badges: [],
            currentQuestionAttempts: 0
        };
        
        let questionTimer = null;
        const TIME_LIMIT = 25;
        let timeLeft = TIME_LIMIT;
        let startTime = 0;
        let stagePoints = 0;

       const sceneParentMap = {
           'tf_questions': 'faculties', 'mc_questions': 'faculties', 
            'exchange_tf_questions': 'exchange', 'exchange_mc_questions': 'exchange', 
           'admission_tf_questions': 'admission', 'admission_mc_questions': 'admission',
            'studentaffairs_tf_questions': 'studentaffairs', 'studentaffairs_mc_questions': 'studentaffairs'
       };
       
        const landingScreen = document.getElementById('landing-screen');
        const startScreen = document.getElementById('start-screen');
        const gameSceneContainer = document.getElementById('game-scene');
        const playerForm = document.getElementById('player-form');
        const playerNameDisplay = document.getElementById('player-name-display');
        const playerScoreDisplay = document.getElementById('player-score-display');
        const statusBar = document.getElementById('status-bar');
        const modal = document.getElementById('feedback-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const correctSound = document.getElementById('correct-sound');
        const incorrectSound = document.getElementById('incorrect-sound');
        const transitionSound = document.getElementById('transition-sound');
        const guideAppearsSound = document.getElementById('guide-appears-sound');
        const badgeSound = document.getElementById('badge-sound');
        const videoOverlay = document.getElementById('video-overlay');
        const welcomeVideo = document.getElementById('welcome-video');
        const skipVideoBtn = document.getElementById('skip-video-btn');
        const adModal = document.getElementById('ad-modal');
        let adShownThisSession = false; 
        let adTriggerQuestionIndex = -1; 
        let isAudioUnlocked = false;
        
        const preloadedImages = new Set();

        function preloadImage(url) {
            if (!url || preloadedImages.has(url)) return;
            const img = new Image();
            img.src = url;
            preloadedImages.add(url);
        }
        
        async function unlockAudio() {
            if (isAudioUnlocked) return;
            const sounds = [correctSound, incorrectSound, transitionSound, guideAppearsSound, badgeSound];
            for (const sound of sounds) {
                try {
                    await sound.play();
                    sound.pause();
                } catch (error) {
                    // console.warn("Audio unlock failed for one sound, this is expected.", error.name);
                }
            }
            isAudioUnlocked = true;
        }

        function playSound(soundElement) {
            if (isAudioUnlocked && soundElement) {
                soundElement.currentTime = 0;
                soundElement.play().catch(error => {
                    console.error(`Could not play sound: ${soundElement.src}`, error);
                });
            }
        }
        
        function showGuideModal(title, message, playSoundEffect = true) {
            const guideInfo = allGuides.find(g => g.id === gameState.selectedGuide);
            if (!guideInfo) return;
            
            if (playSoundEffect) {
                playSound(guideAppearsSound);
            }

            const verb = guideInfo.gender === 'female' ? 'تقول' : 'يقول';

            const modalContent = `
                <div style="text-align: center;">
                    <div class="guide-icon" style="margin: 0 auto 10px; font-size: 48px; width: 80px; height: 80px;">${guideInfo.emoji}</div>
                    <h3 style="color: var(--primary-dark); margin: 0;">${guideInfo.name} ${verb}:</h3>
                    <p style="font-size: 16px; color: var(--text-light); margin-top: 10px;">"${message}"</p>
                </div>
            `;
            
            showModal(title, modalContent, null);
        }
        
        function saveGameState() {
            try {
                const stateToSave = { 
                    ...gameState, 
                    answeredQuestions: Array.from(gameState.answeredQuestions),
                    badges: gameState.badges
                };
                localStorage.setItem('iugGameProgress', JSON.stringify(stateToSave));
            } catch (e) {
                console.error("Failed to save game state:", e);
            }
        }

        function loadGameState() {
            try {
                const savedStateJSON = localStorage.getItem('iugGameProgress');
                if (savedStateJSON) {
                    const savedState = JSON.parse(savedStateJSON);
                    Object.assign(gameState, savedState);
                    gameState.answeredQuestions = new Set(savedState.answeredQuestions);
                    if (!gameState.powerUps) gameState.powerUps = {};
                    if (!gameState.badges) gameState.badges = [];
                    return true;
                }
                return false;
            } catch (e) {
                console.error("Failed to load game state:", e);
                return false;
            }
        }
        
        function addBadge(badgeId) {
            if (!gameState.badges.includes(badgeId)) {
                gameState.badges.push(badgeId);
                saveGameState();
                const badge = badgesData.find(b => b.id === badgeId);
                if (badge) {
                    showBadgePopup(badge.name, badge.emoji);
                }
            }
        }

        function showBadgePopup(name, emoji) {
            const badgeModal = document.getElementById('badge-modal');
            const badgeIcon = badgeModal.querySelector('.badge-icon');
            const badgeName = document.getElementById('badge-name');
            const badgeCloseBtn = document.getElementById('badge-close-btn');

            badgeIcon.textContent = emoji;
            badgeName.textContent = name;
            playSound(badgeSound);
            badgeModal.classList.remove('hidden');

            badgeCloseBtn.onclick = () => {
                badgeModal.classList.add('hidden');
            };
        }
        
        function performLogout() {
            localStorage.removeItem('iugGameProgress');
            location.reload();
        }

        function showLogoutConfirmation() {
            const logoutModal = document.getElementById('logout-confirm-modal');
            logoutModal.classList.remove('hidden');
        }

        function restoreGameSession() {
            if (loadGameState() && gameState.uniquePlayerId) {
                landingScreen.classList.add('hidden');
                startScreen.classList.add('hidden');
                gameSceneContainer.classList.remove('hidden');
                statusBar.classList.remove('hidden');

                updatePlayerStats();

                const sceneToRender = gameState.currentScene && gameData[gameState.currentScene] ? gameState.currentScene : 'map';
                const indexToRender = gameState.currentSubQuestionIndex || 0;

                showModal('أهلاً بعودتك!', `مرحباً ${gameState.playerName}، يسعدنا رؤيتك مجدداً! سنكمل من حيث توقفنا.`, () => {
                    const sceneMappings = {
                        'admission-info': renderAdmissionInfoScene,
                        'exchange-info': renderExchangeInfoScene,
                        'grants-info': renderGrantsInfoScene,
                        'faculties-list': renderFacultiesListScene,
                        'studentaffairs-info': renderStudentAffairsInfoScene,
                        'player-profile': renderPlayerProfile
                    };

                    const parentScene = sceneParentMap[sceneToRender] || sceneToRender;

                    if (sceneMappings[parentScene]) {
                        sceneMappings[parentScene]();
                    } else if (gameData[parentScene] && gameData[parentScene].nextScene) {
                            renderScene(parentScene, indexToRender, false);
                    }
                    else if (sceneToRender) {
                        renderScene(sceneToRender, indexToRender, false);
                    } else {
                        renderScene('map', 0, false);
                    }
                });
                return true;
            }
            return false;
        }
        
        function startGame(event) {
            event.preventDefault();
            const nameInput = document.getElementById('name').value.trim();
            const phoneInput = document.getElementById('phone').value.trim();
            const tawjihiYearInput = document.getElementById('tawjihi-year').value.trim();
            const nameRegex = /^[\u0600-\u06FFa-zA-Z\s]+$/;
            if (nameInput.length < 5 || !nameRegex.test(nameInput)) {
                showModal('تنبيه بخصوص الاسم', 'هذا الاسم سيتم استخدامه في الشهادة، الرجاء كتابته بشكل صحيح (5 حروف على الأقل، وبدون أرقام أو رموز).', null);
                return;
            }
            const phoneRegex = /^05[9|6|4]\d{7}$/;
            if (!phoneRegex.test(phoneInput)) {
                showModal('خطأ في رقم الجوال', 'الرجاء إدخال رقم جوال صحيح يبدأ بـ 059 أو 056 أو 054.', null);
                return;
            }
            const currentYear = new Date().getFullYear();
            const tawjihiYear = parseInt(tawjihiYearInput);
            if (isNaN(tawjihiYear) || tawjihiYear < 2000 || tawjihiYear > currentYear + 1) {
                showModal('خطأ في سنة التوجيهي', 'الرجاء إدخال سنة توجيهي منطقية (مثال: 2024).', null);
                return;
            }
            const startButton = event.target.querySelector('.action-button');
            startButton.disabled = true;
            startButton.innerHTML = 'جاري التسجيل... <span class="spinner"></span>';

            registerPlayer(nameInput, phoneInput, tawjihiYearInput)
                .then(data => {
                    if (data.result === 'success' && data.uniqueId) {
                        gameState.playerName = nameInput;
                        gameState.playerPhone = phoneInput;
                        gameState.tawjihiYear = tawjihiYearInput;
                        gameState.uniquePlayerId = data.uniqueId;
                        saveGameState();
                        updatePlayerStats();
                        startScreen.classList.add('hidden');
                        document.getElementById('guide-selection-screen').classList.remove('hidden');
                    } else {
                        showModal('خطأ في التسجيل', 'حدث خطأ أثناء التسجيل. الرجاء المحاولة مرة أخرى.', null);
                        startButton.disabled = false;
                        startButton.innerHTML = 'ابدأ الرحلة!';
                    }
                })
                .catch(error => {
                    showModal('خطأ في الاتصال', 'فشل الاتصال بالخادم. الرجاء التحقق من اتصالك بالإنترنت.', null);
                    startButton.disabled = false;
                    startButton.innerHTML = 'ابدأ الرحلة!';
                });
        }

        function showEndScene() {
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            const endScene = document.getElementById('end-scene');
            const finalMessage = document.getElementById('final-message');
            finalMessage.textContent = `أحسنت يا ${gameState.playerName}! لقد أتممت رحلتك بنجاح وأظهرت معرفة ممتازة بالجامعة الإسلامية. رصيدك النهائي هو ${gameState.score} نقطة، ويمكنك الآن الحصول على شهادة المشاركة.`;
            endScene.classList.remove('hidden');
            if (gameState.uniquePlayerId) {
                updatePlayerScore(gameState.uniquePlayerId, gameState.score);
            } else {
                console.error("خطأ: لا يمكن تحديث النتيجة لعدم وجود رقم تعريفي.");
            }
        }

        function clearTimer() {
            if (questionTimer) {
                clearInterval(questionTimer);
                questionTimer = null;
            }
        }

        function handleTimeUp() {
            playSound(incorrectSound);

            const sceneId = gameState.currentScene;
            const sceneElement = document.getElementById(`${sceneId}-scene`);
            if (!sceneElement) return;

            const allOptionButtons = sceneElement.querySelectorAll('.option-btn');
            allOptionButtons.forEach(btn => btn.disabled = true);
            
            const currentSceneEl = document.getElementById(`${gameState.currentScene}-scene`);
            const helpBtn = currentSceneEl.querySelector('#guide-help-btn');
            if (helpBtn) helpBtn.disabled = true;

            let sceneData = gameData[sceneId];
            if (Array.isArray(sceneData)) {
                sceneData = sceneData[gameState.currentSubQuestionIndex];
            }
            const correctAnswer = sceneData.correctAnswer;
            const correctButton = sceneElement.querySelector(`.option-btn[data-answer="${correctAnswer}"]`);
            if (correctButton) {
                correctButton.classList.add('correct');
            }

            const modalCallback = () => {
                if (Array.isArray(gameData[sceneId])) {
                    const nextQuestionIndex = gameState.currentSubQuestionIndex + 1;
                    if (nextQuestionIndex < gameData[sceneId].length) {
                        renderScene(sceneId, nextQuestionIndex);
                    } else {
                        const parentScene = sceneParentMap[sceneId];
                        if (parentScene) {
                            const siblingScenes = Object.values(gameData[parentScene].nextScene);
                            const allSiblingsCompleted = siblingScenes.every(siblingId => isStageCompleted(siblingId));
                            if (allSiblingsCompleted) {
                                showModal("إنجاز مذهل!", `لقد أكملت كل تحديات هذا القسم بنجاح. لنعد إلى الخريطة.`, () => renderScene('map'));
                            } else {
                                showModal("انتهت الأسئلة", `لقد أتممت هذا التحدي. يمكنك الآن تجربة النوع الآخر من الأسئلة أو العودة للخريطة.`, () => renderScene(parentScene));
                            }
                        } else {
                            showModal("إنجاز رائع!", `لقد أكملت جميع تحديات هذا القسم بنجاح. لنعد إلى الخريطة.`, () => renderScene('map'));
                        }
                    }
                } else {
                    renderScene('map');
                }
            };
            
            showModal("انتهى الوقت!", "للأسف، لقد نفد الوقت. الإجابة الصحيحة تم تحديدها. استعد للسؤال التالي.", modalCallback);
        }

        function startTimer() {
            clearTimer();
            const currentSceneEl = document.getElementById(`${gameState.currentScene}-scene`);
            if (!currentSceneEl) return; 

            const timerContainer = currentSceneEl.querySelector('#timer-container');
            const timerDisplay = currentSceneEl.querySelector('#timer-display');
            if (!timerDisplay || !timerContainer) return;

            timeLeft = TIME_LIMIT;
            startTime = Date.now();
            timerDisplay.textContent = timeLeft;
            timerContainer.classList.remove('low-time');

            questionTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 5 && timeLeft > 0) {
                    timerContainer.classList.add('low-time');
                }
                if (timeLeft < 0) {
                    clearTimer();
                    handleTimeUp();
                }
            }, 1000);
        }

        function renderScene(sceneId, questionIndex = 0, pushState = true) {
            clearTimer();
            gameState.currentQuestionAttempts = 0;
            if (questionIndex === 0) stagePoints = 0;

            if (questionIndex === 0 && sceneId !== 'map' && guideMessages[sceneId]) {
                const messageSceneId = sceneParentMap[sceneId] || sceneId;
                if(guideMessages[messageSceneId] && guideMessages[messageSceneId][gameState.selectedGuide]) {
                    setTimeout(() => showGuideModal('رسالة من مرشدك', guideMessages[messageSceneId][gameState.selectedGuide]), 500);
                }
            }
            playSound(transitionSound);
            
            if (pushState) history.pushState({ scene: sceneId, index: questionIndex }, '');
            
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));

            if ((sceneId.includes('questions')) && questionIndex === 0 && !adShownThisSession) {
                const sceneData = gameData[sceneId];
                if (sceneData.length > 3) {
                    const minTrigger = 1; 
                    const maxTrigger = Math.min(sceneData.length - 2, 4); 
                    adTriggerQuestionIndex = Math.floor(Math.random() * (maxTrigger - minTrigger + 1)) + minTrigger;
                }
            }

            const sceneMappings = {
                'map': () => document.getElementById('map-scene').classList.remove('hidden'),
                'faculties-list': renderFacultiesListScene,
                'grants-info': renderGrantsInfoScene,
                'admission-info': renderAdmissionInfoScene,
                'exchange-info': renderExchangeInfoScene,
                'studentaffairs-info': renderStudentAffairsInfoScene,
                'player-profile': renderPlayerProfile,
                'stadium': renderStadiumGame,
            };

            if (sceneMappings[sceneId]) {
                sceneMappings[sceneId]();
                return;
            }

            const sceneElementId = `${sceneId}-scene`;
            const sceneElement = document.getElementById(sceneElementId);
            let sceneData = gameData[sceneId];

            if (!sceneData || !sceneElement) {
                console.error(`Scene data or element not found for: ${sceneId}`);
                showModal("خطأ", "حدث خطأ غير متوقع، سنعيدك للخريطة.", () => renderScene('map'));
                return;
            }

            gameState.currentScene = sceneId;
            if (Array.isArray(sceneData)) {
                gameState.currentSubQuestionIndex = questionIndex;
                sceneData = sceneData[questionIndex];
            } else {
                gameState.currentSubQuestionIndex = 0;
            }
            saveGameState();

            let progressInfoHTML = '';
            if (Array.isArray(gameData[sceneId])) {
                const totalQuestions = gameData[sceneId].length;
                const currentQuestionNumber = questionIndex + 1;
                const currentProgress = (currentQuestionNumber / totalQuestions) * 100;
                const progressBarHTML = `<div class="progress-bar-container"><div class="progress-bar" style="width: ${currentProgress}%"></div></div>`;
                const questionCounterHTML = `<div class="question-counter">السؤال ${currentQuestionNumber} من ${totalQuestions}</div>`;
                const timerHTML = `<div id="timer-container" class="timer-container"><span id="timer-display">${TIME_LIMIT}</span></div>`;
                progressInfoHTML = `<div class="progress-info">${progressBarHTML}${timerHTML}${questionCounterHTML}</div>`;
            }
            
            let optionsHTML = '';
            let delay = 0;
            let optionKeys = Object.keys(sceneData.options);

            if (sceneData.correctAnswer !== null) optionKeys = shuffleArray(optionKeys);

            for (const key of optionKeys) {
                optionsHTML += `<button class="option-btn" data-answer="${key}" style="animation-delay: ${delay}s">${sceneData.options[key]}</button>`;
                delay += 0.1;
            }
            
            let powerUpsHTML = '';
            if (sceneData.correctAnswer !== null) {
                const stageId = sceneParentMap[sceneId] || sceneId;
                if (!gameState.powerUps[stageId]) {
                    gameState.powerUps[stageId] = { fiftyFifty: 3, extraTime: 3, skip: 3 };
                }
                const stagePowerUps = gameState.powerUps[stageId];
                const isMCQ4 = Object.keys(sceneData.options).length === 4;
                powerUpsHTML = `
                    <div class="power-ups-container">
                        <button id="guide-help-btn" class="guide-help-button">💡 مساعدة المرشد (-0.5 نقطة)</button>
                        <button id="fifty-fifty-btn" class="power-up-btn" ${stagePowerUps.fiftyFifty > 0 && isMCQ4 ? '' : 'disabled'}>50/50 <span class="power-up-counter">${stagePowerUps.fiftyFifty}</span></button>
                        <button id="extra-time-btn" class="power-up-btn" ${stagePowerUps.extraTime > 0 ? '' : 'disabled'}>⏱️ +15 <span class="power-up-counter">${stagePowerUps.extraTime}</span></button>
                        <button id="skip-q-btn" class="power-up-btn" ${stagePowerUps.skip > 0 ? '' : 'disabled'}>⏭️ تخطي <span class="power-up-counter">${stagePowerUps.skip}</span></button>
                    </div>`;
            }

            sceneElement.innerHTML = `
                <img src="${sceneData.image}" alt="صورة مشهد ${sceneId}" class="scene-image" loading="lazy">
                <div class="scene-content">
                    ${progressInfoHTML}
                    <p class="scene-title">${sceneData.question}</p>
                    ${powerUpsHTML}
                    <div class="options-container">${optionsHTML}</div>
                </div>`;

            sceneElement.classList.remove('hidden');
            sceneElement.querySelector('.options-container').addEventListener('click', handleAnswer);
            
            const powerUpsContainer = sceneElement.querySelector('.power-ups-container');
            if (powerUpsContainer) {
                powerUpsContainer.addEventListener('click', (event) => {
                    const button = event.target.closest('.power-up-btn, .guide-help-button');
                    if (!button) return;
                    switch (button.id) {
                        case 'guide-help-btn': useGuideHelp(); break;
                        case 'fifty-fifty-btn': useFiftyFifty(); break;
                        case 'extra-time-btn': useExtraTime(); break;
                        case 'skip-q-btn': useSkipQuestion(); break;
                    }
                });
            }
            startTimer();
        }

        function renderStudentAffairsInfoScene() {
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            const sceneElement = document.getElementById('studentaffairs-info-scene');
            sceneElement.classList.remove('hidden');
            gameState.currentScene = 'studentaffairs-info';
            saveGameState();

            const container = document.getElementById('studentaffairs-info-container');
            container.innerHTML = `<nav class="tabs-nav"><button class="tab-btn active" data-tab="about">عن العمادة</button><button class="tab-btn" data-tab="services">الأقسام والخدمات</button><button class="tab-btn" data-tab="gallery">ألبوم الصور</button></nav><div class="tabs-content"><div id="tab-about" class="tab-pane active"><div class="info-scene-container"><p>أهلاً وسهلاً بكم في عمادة شئون الطلبة بالجامعة الإسلامية. تعد عمادة شؤون الطلبة من أهم العمادات بالجامعة المختصة بالطلبة، فهي  تعنى بتقديم الخدمات الطلابية، والتي تسهم في تنظيم الأنشطة اللامنهجية والأعمال التطوعية، وتساعد الطالب في إنجاز المعاملات وتسهيل عملية التسجيل والتسجيل للمنح الداخلية والخارجية والقروض الجامعية.</p><h3 class="info-section-title">تاريخ ومهام</h3><p>أنشئت عمادة شؤون الطلبة في عام 1981م. وقد أنيطت بها المهام التالية:</p><ul class="info-list"><li>دراسة مشكلات الطلبة الاقتصادية، ووضع الحلول لها من خلال قسم البحث الاجتماعي.</li><li>الإشراف على النشاط الثقافي والاجتماعي والرياضي والفني بالتنسيق مع مجالس الطلبة.</li><li>متابعة اجتماعيات مجالس الطلبة، وإرشادهم إلى طريق العمل السليم.</li><li>النظر في مشكلات الطلبة اليومية العامة والخاصة، وتنسيب الحلول الملائمة لها.</li><li>الإشراف على حسن استخدام مرافق الجامعة استخداماً سليماً.</li><li>مراقبة انتظام الدراسة، وبحث ظاهرة التغيب، وتنسيب الحلول الملائمة لها.</li></ul></div></div><div id="tab-services" class="tab-pane"><div class="info-scene-container"><div class="accordion-item"><div class="accordion-header">قسم البحث الاجتماعي "خدمات الطلبة"</div><div class="accordion-content"><p>يعد قسم البحث الاجتماعي البوابة الأساسية لمساعدة الطلبة ماليا بهدف إكمال المسيرة التعليمية. وبناءً عليه يتم الاستفادة من خدمات العمادة المتعلقة بالمنح الخارجية والقروض الجامعية.</p><strong>الخطوات المتبعة للاستفادة:</strong><ul class="info-list"><li>يتم توجيه الطلبة لتعبئة استمارة البحث الاجتماعي الكترونيا.</li><li>يقوم الطالب بإرفاق الأوراق الثبوتية الأصلية الكترونيا.</li><li>يقوم الطالب بإحضار الأوراق الثبوتية وتسلميها لموظفي البحث الاجتماعي، لتدقيقها.</li><li>يتم تصنيف حالات الطلبة وفق معايير خاصة تحدد الحالة الاجتماعية للطالب.</li><li>بناء على نتيجة البحث الاجتماعي لكل طالب يتم ترشيح الطلبة للمنح الخارجية.</li></ul></div></div><div class="accordion-item"><div class="accordion-header">الأنشطة اللامنهجية والعمل التطوعي</div><div class="accordion-content"><p>هي مجموعة من الفعاليات المتنوعة الثقافية – الفنية – التدريبية – العلمية والترويحية التي تهدف إلى تنمية شخصية الطالب الجامعي وتزويده بالمهارات والخبرات واستثمار اوقات الفراغ. أما العمل التطوعي فهو أحد المساقات التي تشرف عليها العمادة لتكليف الطلبة بأنشطة وفعاليات تطوعية تصقل مواهبهم.</p></div></div><div class="accordion-item"><div class="accordion-header">قسم النشاط الرياضي</div><div class="accordion-content"><p>لقد أولت عمادة شئون الطلبة الأنشطة الرياضية الفردية والجماعية اهتماما كبيرا لما لها من أثر في صقل وتهذيب شخصية الطالب. ومن أهدافه بث الروح الرياضية، تنمية مواهب الطلبة، غرس المفاهيم الصحيحة للتربية البدنية، نشر الوعي الرياضي، وإعداد المنتخبات لتمثيل الجامعة.</p></div></div><div class="accordion-item"><div class="accordion-header">وحدة التوجيه والارشاد</div><div class="accordion-content"><p>تقدم الوحدة الخدمات التالية للطلبة:</p><ul class="info-list"><li>إرشاد وتوجيه وتوعية.</li><li>استشارات.</li><li>ندوات ومحاضرات.</li><li>ورش عمل.</li><li>دورات ذات علاقة.</li></ul></div></div></div></div><div id="tab-gallery" class="tab-pane"><div class="info-scene-container"><div class="photo-gallery"><img src="https://i.imgur.com/uStyY1N.jpeg" alt="استقبال الطلبة" loading="lazy"><img src="https://i.imgur.com/vHqB3Tj.jpeg" alt="زيارة طلبة الثانوية" loading="lazy"><img src="https://i.imgur.com/1mYdPo3.jpeg" alt="فريق الدبكة" loading="lazy"><img src="https://i.imgur.com/QhXpBmg.jpeg" alt="زيارة الصالة الرياضية" loading="lazy"><img src="https://i.imgur.com/A6mJTOq.jpeg" alt="زيارة لرئيس الجامعة" loading="lazy"><img src="https://i.imgur.com/o1bFjHj.jpeg" alt="استقبال في الأيام الترفيهية" loading="lazy"><img src="https://i.imgur.com/L8JgY1g.jpeg" alt="فريق شئون الطلبة" loading="lazy"><img src="https://i.imgur.com/w2Y9w5E.jpeg" alt="ضيافة طلبة الثانوية" loading="lazy"></div></div></div></div>`;
            
            const tabsContainer = sceneElement.querySelector('.tabs-nav');
            const accordions = sceneElement.querySelectorAll('.accordion-item');

            tabsContainer.addEventListener('click', e => {
                if (e.target.classList.contains('tab-btn')) {
                    tabsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    sceneElement.querySelector('.tab-pane.active').classList.remove('active');
                    const targetTab = e.target.dataset.tab;
                    sceneElement.querySelector(`#tab-${targetTab}`).classList.add('active');
                }
            });

            accordions.forEach(item => {
                const header = item.querySelector('.accordion-header');
                header.addEventListener('click', () => {
                    const content = item.querySelector('.accordion-content');
                    if (item.classList.toggle('active')) {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    } else {
                        content.style.maxHeight = '0px';
                    }
                });
            });

            document.getElementById('start-studentaffairs-quiz-btn').onclick = () => renderScene('studentaffairs');
        }

        function renderAdmissionInfoScene() {
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            const sceneElement = document.getElementById('admission-info-scene');
            sceneElement.classList.remove('hidden');
            gameState.currentScene = 'admission-info';
            saveGameState();
            const container = document.getElementById('admission-info-container');
            container.innerHTML = ''; 
            admissionInfoData.forEach(facultyData => {
                const card = document.createElement('div');
                card.className = 'admission-card';
                let specializationsHTML = '<ul>';
                facultyData.specializations.forEach(spec => {
                    const isNew = spec.name.includes('(جديد)');
                    specializationsHTML += `<li><span class="specialization">${spec.name.replace(' (جديد)', '')} ${isNew ? '<span class="score new-major">جديد</span>' : ''}</span><span class="score">${spec.score}</span></li>`;
                });
                specializationsHTML += '</ul>';
                card.innerHTML = `<h3>${facultyData.faculty}</h3>${specializationsHTML}`;
                container.appendChild(card);
            });
            document.getElementById('start-admission-quiz-btn').onclick = () => renderScene('admission');
        }

        function renderGrantsInfoScene() {
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            document.getElementById('grants-info-scene').classList.remove('hidden');
            gameState.currentScene = 'grants-info';
            saveGameState();
            document.getElementById('start-grants-quiz-btn').onclick = () => renderScene('grants');
        }
        
        function renderExchangeInfoScene() {
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            document.getElementById('exchange-info-scene').classList.remove('hidden');
            gameState.currentScene = 'exchange-info';
            saveGameState();
            document.getElementById('start-exchange-quiz-btn').onclick = () => renderScene('exchange');
        }
        
        function handleAnswer(event) {
            const targetButton = event.target.closest('.option-btn');
            if (!targetButton || targetButton.disabled) return;

            const sceneId = gameState.currentScene;
            let sceneData = gameData[sceneId];
            let questionId;

            if (Array.isArray(sceneData)) {
                sceneData = sceneData[gameState.currentSubQuestionIndex];
                questionId = sceneData.id;
            } else {
                questionId = sceneData.id || sceneId;
            }

            const selectedAnswer = targetButton.dataset.answer;

            if (sceneData.nextScene && sceneData.nextScene[selectedAnswer]) {
                renderScene(sceneData.nextScene[selectedAnswer]);
                return;
            }

            clearTimer();
            gameState.currentQuestionAttempts++;
            saveGameState();

            const allOptionButtons = document.querySelectorAll(`#${sceneId}-scene .option-btn`);
            const helpBtn = document.getElementById('guide-help-btn');
            const isCorrect = selectedAnswer === sceneData.correctAnswer;
            
            const proceedToNextStep = () => {
                if ((sceneId.includes('questions')) && !adShownThisSession && gameState.currentSubQuestionIndex === adTriggerQuestionIndex) {
                    setTimeout(showAdModal, 500);
                }

                if (sceneId === 'gate') {
                    playWelcomeVideo();
                } else if (Array.isArray(gameData[sceneId])) {
                    const nextQuestionIndex = gameState.currentSubQuestionIndex + 1;
                    if (nextQuestionIndex >= gameData[sceneId].length) {
                        giveBadgesForStage(sceneId);
                    }
                    if (nextQuestionIndex < gameData[sceneId].length) {
                        renderScene(sceneId, nextQuestionIndex);
                    } else {
                        const parentScene = sceneParentMap[sceneId];
                        if (parentScene) {
                            const allSiblingsCompleted = Object.values(gameData[parentScene].nextScene).every(isStageCompleted);
                            if (allSiblingsCompleted) {
                                showModal("إنجاز مذهل!", `لقد أكملت كل تحديات هذا القسم بنجاح. لنعد إلى الخريطة.`, () => renderScene('map'));
                            } else {
                                showModal("رائع!", `لقد أتممت هذا التحدي. يمكنك الآن تجربة النوع الآخر من الأسئلة أو العودة للخريطة.`, () => renderScene(parentScene));
                            }
                        } else {
                            showModal("إنجاز رائع!", `لقد أكملت جميع تحديات هذا القسم بنجاح. لنعد إلى الخريطة.`, () => renderScene('map'));
                        }
                    }
                } else {
                    renderScene('map');
                }
            };

            if (isCorrect) {
                playSound(correctSound);
                targetButton.classList.add('correct');
                allOptionButtons.forEach(btn => btn.disabled = true);
                if (helpBtn) helpBtn.disabled = true;

                if (!gameState.answeredQuestions.has(questionId)) {
                    gameState.score += sceneData.points;
                    stagePoints += sceneData.points;
                    gameState.answeredQuestions.add(questionId);
                    updatePlayerStats();
                    updatePlayerScore(gameState.uniquePlayerId, gameState.score);
                    saveGameState();
                }

                let feedback = (sceneData.correctFeedback && (sceneData.correctFeedback[gameState.selectedGuide] || sceneData.correctFeedback.default)) || 'إجابة صحيحة!';
                showModal("إجابة صحيحة!", feedback, proceedToNextStep);

            } else {
                playSound(incorrectSound);
                targetButton.classList.add('incorrect');
                targetButton.disabled = true;

                if (gameState.currentQuestionAttempts < 2) {
                    showModal("محاولة خاطئة", "لديك فرصة أخرى للإجابة. ركّز جيداً!", null);
                } else {
                    allOptionButtons.forEach(btn => btn.disabled = true);
                    if (helpBtn) helpBtn.disabled = true;

                    const correctButton = document.querySelector(`#${sceneId}-scene .option-btn[data-answer="${sceneData.correctAnswer}"]`);
                    if (correctButton) {
                        correctButton.classList.add('correct');
                    }

                    let feedback = (sceneData.incorrectFeedback && (sceneData.incorrectFeedback[gameState.selectedGuide] || sceneData.incorrectFeedback.default)) || 'إجابة غير صحيحة.';
                    showModal("إجابة خاطئة", feedback + "<br>الإجابة الصحيحة تم تحديدها بالأخضر.", proceedToNextStep);
                }
            }
        }
        
        function giveBadgesForStage(stageId) {
            const totalPoints = gameData[stageId].length;

            if (stagePoints === totalPoints) {
                addBadge('perfect-score');
            }
            
            const mainStageId = sceneParentMap[stageId] || stageId;
            switch (mainStageId) {
                case 'library': addBadge('library-expert'); break;
                case 'faculties': addBadge('faculties-expert'); break;
                case 'grants': addBadge('grants-master'); break;
                case 'exchange': addBadge('exchange-master'); break;
                case 'studentaffairs': addBadge('student-affairs-master'); break;
                case 'admission': addBadge('admission-master'); break;
            }
            
            const completionTime = (Date.now() - startTime) / 1000;
            if (completionTime < 120 && totalPoints > 3) {
                 addBadge('speed-runner');
            }
        }

        function useGuideHelp() {
            const currentSceneEl = document.getElementById(`${gameState.currentScene}-scene`);
            if (!currentSceneEl) return;
            const helpBtn = currentSceneEl.querySelector('#guide-help-btn');

            if (!helpBtn || helpBtn.disabled) return;

            if (gameState.score < 0.5) {
                showModal("رصيد غير كافٍ", "عذراً، لا تملك نصف نقطة لاستخدام المساعدة.", null);
                return;
            }

            helpBtn.disabled = true;
            gameState.score -= 0.5;
            updatePlayerStats();
            updatePlayerScore(gameState.uniquePlayerId, gameState.score);
            saveGameState();

            let sceneData = gameData[gameState.currentScene];
            if (Array.isArray(sceneData)) {
                sceneData = sceneData[gameState.currentSubQuestionIndex];
            }

            const hint = (sceneData.hint && (sceneData.hint[gameState.selectedGuide] || sceneData.hint.default)) || 'فكر جيداً، يمكنك فعلها!';
            showGuideModal("مساعدة من مرشدك", hint, false);
        }

        function useFiftyFifty() {
            const currentSceneEl = document.getElementById(`${gameState.currentScene}-scene`);
            const btn = currentSceneEl.querySelector('#fifty-fifty-btn');
            if (!btn || btn.disabled) return;

            const stageId = sceneParentMap[gameState.currentScene] || gameState.currentScene;
            if (gameState.powerUps[stageId].fiftyFifty <= 0) return;

            gameState.powerUps[stageId].fiftyFifty--;
            saveGameState();
            btn.querySelector('.power-up-counter').textContent = gameState.powerUps[stageId].fiftyFifty;
            btn.disabled = true;

            let sceneData = gameData[gameState.currentScene];
            if (Array.isArray(sceneData)) {
                sceneData = sceneData[gameState.currentSubQuestionIndex];
            }
            
            const options = document.querySelectorAll(`#${gameState.currentScene}-scene .option-btn`);
            const wrongAnswers = [];
            options.forEach(opt => {
                if (opt.dataset.answer !== sceneData.correctAnswer) {
                    wrongAnswers.push(opt);
                }
            });

            shuffleArray(wrongAnswers).slice(0, 2).forEach(opt => {
                opt.disabled = true;
                opt.style.opacity = '0.5';
            });
        }

        function useExtraTime() {
            const currentSceneEl = document.getElementById(`${gameState.currentScene}-scene`);
            const btn = currentSceneEl.querySelector('#extra-time-btn');   
            if (!btn || btn.disabled) return;

            const stageId = sceneParentMap[gameState.currentScene] || gameState.currentScene;
            if (gameState.powerUps[stageId].extraTime <= 0) return;

            gameState.powerUps[stageId].extraTime--;
            saveGameState();
            btn.querySelector('.power-up-counter').textContent = gameState.powerUps[stageId].extraTime;
            btn.disabled = true;
            
            timeLeft += 15;
            const timerDisplay = document.getElementById('timer-display');
            if(timerDisplay) timerDisplay.textContent = timeLeft;
        }

        function useSkipQuestion() {
            const currentSceneEl = document.getElementById(`${gameState.currentScene}-scene`);
            const btn = currentSceneEl.querySelector('#skip-q-btn');
            if (!btn || btn.disabled) return;

            const stageId = sceneParentMap[gameState.currentScene] || gameState.currentScene;
            if (gameState.powerUps[stageId].skip <= 0) return;
            
            if (gameState.score < 0.5) {
                showModal("رصيد غير كافٍ", "عذراً، لا تملك نصف نقطة لتخطي السؤال.", null);
                return;
            }

            gameState.powerUps[stageId].skip--;
            gameState.score -= 0.5;
            updatePlayerStats();
            updatePlayerScore(gameState.uniquePlayerId, gameState.score);
            saveGameState();
            clearTimer();
            
            const sceneId = gameState.currentScene;
            const nextQuestionIndex = gameState.currentSubQuestionIndex + 1;

            if (nextQuestionIndex < gameData[sceneId].length) {
                renderScene(sceneId, nextQuestionIndex);
            } else {
                showModal("انتهت الأسئلة", "لقد أنهيت هذه المرحلة.", () => renderScene('map'));
            }
        }

        function updatePlayerStats() {
            playerNameDisplay.textContent = gameState.playerName;
            playerScoreDisplay.innerHTML = `💰 ${gameState.score} نقطة`;
        }

        function showModal(title, text, callback) {
            modalTitle.textContent = title;
            modalText.innerHTML = text;
            modal.classList.remove('hidden');
            modalCloseBtn.onclick = () => {
                modal.classList.add('hidden');
                if (callback) callback();
            };
        }

        function endVideoAndProceed() {
            welcomeVideo.pause();
            welcomeVideo.currentTime = 0;
            videoOverlay.classList.add('hidden');
            renderScene('map');
        }

        function playWelcomeVideo() {
            videoOverlay.classList.remove('hidden');
            welcomeVideo.play();
            welcomeVideo.onended = endVideoAndProceed;
            skipVideoBtn.onclick = endVideoAndProceed;
        }

        function showAdModal() {
            adModal.classList.remove('hidden');
            adShownThisSession = true;
        }
        
        function isStageCompleted(stageId) {
            let stageData = gameData[stageId];
            if (!stageData) return false;
            if (stageId === 'stadium') {
                return gameState.answeredQuestions.has('stadium-game-completed');
            }
            if (stageId === 'faculties' || stageId === 'exchange' || stageId === 'admission' || stageId === 'studentaffairs') {
                const subScenes = Object.values(stageData.nextScene);
                return subScenes.every(s => isStageCompleted(s));
            }
            if (Array.isArray(stageData)) {
                return stageData.every(q => gameState.answeredQuestions.has(q.id));
            }
             if (stageData.id) {
                return gameState.answeredQuestions.has(stageData.id);
            }
            return false;
        }
        
        playerForm.addEventListener('submit', startGame);

        document.getElementById('map-scene').addEventListener('click', (e) => {
            const button = e.target.closest('.option-btn');
            if (!button) return;
            const destination = button.dataset.destination;
            
            const mainDestinationId = destination.replace('-info', '').replace('-list', '');

          if (destination === 'stadium') {
            renderStadiumGame();
            return;
        }
            if (isStageCompleted(mainDestinationId) && destination !== 'certificate') {
                showModal("مكان مألوف!", "لقد أكملت جميع تحديات هذا المكان. اختر وجهة أخرى.", null);
                return;
            }

            const destinationData = gameData[destination];

            if (destinationData && destinationData.isInfoScreen) {
                const sceneMappings = {
                    'grants-info': renderGrantsInfoScene,
                    'admission-info': renderAdmissionInfoScene,
                    'faculties-list': renderFacultiesListScene,
                    'exchange-info': renderExchangeInfoScene,
                    'studentaffairs-info': renderStudentAffairsInfoScene,
                };
                if(sceneMappings[destination]) sceneMappings[destination]();
                return;
            }
            
            if (destination === 'certificate') {
                const libraryComplete = isStageCompleted('library');
                const facultiesComplete = isStageCompleted('faculties');
                const exchangeComplete = isStageCompleted('exchange');
                const admissionComplete = isStageCompleted('admission');
                const studentAffairsComplete = isStageCompleted('studentaffairs');
                const allKeyStagesComplete = libraryComplete && facultiesComplete && exchangeComplete && admissionComplete && studentAffairsComplete;
                const scoreSufficient = gameState.score >= 50;
                if (allKeyStagesComplete && scoreSufficient) {
                    showEndScene();
                } else {
                    let message = "الطريق إلى الشهادة لم يكتمل بعد!<br><br>للحصول عليها، يجب عليك تحقيق شرطين:<br>";
                    message += `1. إكمال التحديات الرئيسية.<br>`;
                    message += `(${libraryComplete ? '✔️' : '❌'} المكتبة) | (${facultiesComplete ? '✔️' : '❌'} الكليات) | (${exchangeComplete ? '✔️' : '❌'} التبادل) | (${admissionComplete ? '✔️' : '❌'} القبول) | (${studentAffairsComplete ? '✔️' : '❌'} شؤون الطلبة)<br>`;
                    message += `2. الحصول على 50 نقطة على الأقل (رصيدك: ${gameState.score}). (${scoreSufficient ? '✔️' : '❌'})<br><br>استمر في رحلتك!`;
                    showModal("شروط الحصول على الشهادة", message, null);
                }
                return;
            }
            
            if (destinationData && destinationData.isUnderConstruction) {
                showModal("قيد الإنشاء!", "هذا الجزء من الجامعة سيتم افتتاحه قريباً في التحديثات القادمة للعبة.", null);
                return;
            }

            if (destinationData) renderScene(mainDestinationId);
            else showModal("خطأ", "لم يتم العثور على الوجهة المطلوبة.", null);
        });
        
        document.addEventListener('click', function(event) {
            if (event.target.closest('#show-register-btn')) {
                landingScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            }
            if (event.target.closest('#logout-btn')) {
                event.preventDefault();
                showLogoutConfirmation();
            }
            if (event.target.closest('#reset-progress-btn')) {
                event.preventDefault();
                showLogoutConfirmation();
            }
            if (event.target.closest('#back-to-map-btn')) {
                event.preventDefault();
                renderScene('map');
            }
            if (event.target.closest('#profile-btn')) {
                event.preventDefault();
                renderPlayerProfile();
            }
        });

        adModal.addEventListener('click', (event) => {
            if (event.target.classList.contains('close-ad-btn') || event.target.id === 'ad-modal') {
                adModal.classList.add('hidden');
            }
        });
        
        document.getElementById('new-player-btn').addEventListener('click', performLogout);

        const logoutModal = document.getElementById('logout-confirm-modal');
        document.getElementById('confirm-logout-btn').addEventListener('click', performLogout);
        document.getElementById('cancel-logout-btn').addEventListener('click', () => {
            logoutModal.classList.add('hidden');
        });
        
        document.getElementById('profile-back-btn').addEventListener('click', () => {
            document.getElementById('player-profile-scene').classList.add('hidden');
            renderScene('map');
        });
        
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.scene) {
                const sceneMappings = {
                    'admission-info': renderAdmissionInfoScene,
                    'exchange-info': renderExchangeInfoScene,
                    'grants-info': renderGrantsInfoScene,
                    'faculties-list': renderFacultiesListScene,
                    'studentaffairs-info': renderStudentAffairsInfoScene,
                    'player-profile': renderPlayerProfile
                };
                if (sceneMappings[event.state.scene]) {
                    sceneMappings[event.state.scene]();
                } else {
                    renderScene(event.state.scene, event.state.index, false);
                }
            } else {
                if (gameState.uniquePlayerId) renderScene('map', 0, false);
                else location.reload();
            }
        });
        
        function populateFacultiesList() {
            const container = document.getElementById('faculties-grid-container');
            let content = '';
            collegesData.forEach(college => {
                content += `<div class="college-info-card" data-url="${college.url}" data-name="${college.name}"><h3>${college.emoji} ${college.name}</h3><p>${college.description}</p></div>`;
            });
            container.innerHTML = content;
        }

        function renderFacultiesListScene() {
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            document.getElementById('faculties-list-scene').classList.remove('hidden');
            gameState.currentScene = 'faculties-list';
            saveGameState();
        }
        
        document.getElementById('faculties-grid-container').addEventListener('click', (e) => {
            const card = e.target.closest('.college-info-card');
            if (!card) return;
            const url = card.dataset.url;
            const name = card.dataset.name;
            const websiteScene = document.getElementById('college-website-scene');
            websiteScene.innerHTML = `<div class="scene-content"><div class="website-view-header"><button id="back-to-list-btn" class="action-button" style="width: auto; padding: 10px 20px;"><span class="btn-icon">➡️</span> رجوع لقائمة الكليات</button></div><div class="loader-container" id="loader-container"><div class="loader"></div><p>جاري تحميل صفحة الكلية...</p></div></div>`;
            document.getElementById('back-to-list-btn').addEventListener('click', () => {
                websiteScene.classList.add('hidden');
                websiteScene.innerHTML = ''; 
                document.getElementById('faculties-list-scene').classList.remove('hidden');
            });
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            websiteScene.classList.remove('hidden');
            const iframe = document.createElement('iframe');
            iframe.id = 'college-website-iframe';
            iframe.src = url;
            iframe.title = name;
            iframe.onload = () => {
                const loaderContainer = document.getElementById('loader-container');
                if (loaderContainer) loaderContainer.remove();
                iframe.classList.add('loaded');
            };
            websiteScene.querySelector('.scene-content').appendChild(iframe);
        });

        document.getElementById('proceed-to-faculties-quiz-btn').addEventListener('click', () => {
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            renderScene('faculties');
        });

        function populateGuideSelection() {
            const container = document.querySelector('#guide-selection-screen .guides-container');
            container.innerHTML = ''; 
            allGuides.forEach(guide => {
                const cardHTML = `
                    <div class="guide-card" data-guide="${guide.id}">
                        <div class="guide-icon">${guide.emoji}</div>
                        <h3>${guide.name}</h3>
                        <span>${guide.college}</span>
                        <p>${guide.description}</p>
                    </div>
                `;
                container.innerHTML += cardHTML;
            });
        }

        const guideSelectionScreen = document.getElementById('guide-selection-screen');
        const guidesContainer = guideSelectionScreen.querySelector('.guides-container');
        const confirmGuideBtn = document.getElementById('confirm-guide-btn');
        
        guidesContainer.addEventListener('click', (e) => {
            const selectedCard = e.target.closest('.guide-card');
            if (!selectedCard) return;
            guidesContainer.querySelectorAll('.guide-card').forEach(card => card.classList.remove('selected'));
            selectedCard.classList.add('selected');
            gameState.selectedGuide = selectedCard.dataset.guide;
            confirmGuideBtn.disabled = false;
        });

        confirmGuideBtn.addEventListener('click', () => {
            if (gameState.selectedGuide) {
                saveGameState();
                guideSelectionScreen.classList.add('hidden');
                gameSceneContainer.classList.remove('hidden');
                statusBar.classList.remove('hidden');
                showModal(`اختيار موفق!`, `مرشدك الأكاديمي سيكون بجانبك. لنبدأ الرحلة الآن!`, () => {
                    renderScene('gate');
                });
            }
        });
        
        function renderPlayerProfile() {
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            const profileScene = document.getElementById('player-profile-scene');
            profileScene.classList.remove('hidden');

            const profileName = document.getElementById('profile-name');
            const profileEmoji = document.getElementById('profile-emoji');
            const profileScore = document.getElementById('profile-score');
            const profileTawjihiYear = document.getElementById('profile-tawjihi-year');

            const selectedGuideInfo = allGuides.find(g => g.id === gameState.selectedGuide);
            profileName.textContent = gameState.playerName;
            profileEmoji.textContent = selectedGuideInfo ? selectedGuideInfo.emoji : '👤';
            profileScore.textContent = `${gameState.score} نقطة`;
            profileTawjihiYear.textContent = gameState.tawjihiYear;

            const badgesContainer = document.getElementById('badges-container');
            const noBadgesMsg = document.getElementById('no-badges-msg');
            badgesContainer.innerHTML = ''; 
            
            if (gameState.badges.length > 0) {
                noBadgesMsg.classList.add('hidden');
                gameState.badges.forEach(badgeId => {
                    const badgeInfo = badgesData.find(b => b.id === badgeId);
                    if (badgeInfo) {
                        const badgeCard = document.createElement('div');
                        badgeCard.className = 'badge-card';
                        badgeCard.innerHTML = `<span class="badge-icon">${badgeInfo.emoji}</span><p>${badgeInfo.name}</p>`;
                        badgesContainer.appendChild(badgeCard);
                    }
                });
            } else {
                noBadgesMsg.classList.remove('hidden');
            }
            gameState.currentScene = 'player-profile';
            saveGameState();
        }
    // ========== بداية كود لعبة الملعب ==========
        function renderStadiumGame() {
            const sceneElement = document.getElementById('stadium-scene');
            if (!sceneElement) {
                console.error("ERROR: Stadium scene element not found!");
                showModal("خطأ فني", "لم يتم العثور على عنصر اللعبة. الرجاء التأكد من عدم وجود أخطاء في ملف HTML.", () => renderScene('map'));
                return;
            }
            
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            sceneElement.classList.remove('hidden');
            gameState.currentScene = 'stadium';
            saveGameState();

            let playerScore = 0;
            let keeperScore = 0;
            let shotsTaken = 0;
            const totalShots = 5;

            sceneElement.innerHTML = `
                <div class="scene-content">
                    <div class="stadium-score-board">
                        <div id="stadium-player-score">أنت: 0</div>
                        <div id="stadium-keeper-score">الحارس: 0</div>
                    </div>
                    <div class="stadium-game-board" id="stadium-game-board">
                        <div class="stadium-goal" id="stadium-goal">
                            <div class="stadium-keeper" id="stadium-keeper">🧍‍♂️✋</div>
                        </div>
                        <div class="stadium-ball" id="stadium-ball">🏃‍♂️⚽</div>
                    </div>
                    <div class="stadium-controls">
                        <p class="stadium-instructions" id="stadium-instructions">انقر على المرمى للتسديد!</p>
                        <div class="stadium-shots-indicator" id="stadium-shots-indicator"></div>
                    </div>
                </div>`;

            const gameBoard = document.getElementById('stadium-game-board');
            const goal = document.getElementById('stadium-goal');
            const ball = document.getElementById('stadium-ball');
            const keeper = document.getElementById('stadium-keeper');
            const instructions = document.getElementById('stadium-instructions');
            const playerScoreDisplay = document.getElementById('stadium-player-score');
            const keeperScoreDisplay = document.getElementById('stadium-keeper-score');
            const shotsIndicator = document.getElementById('stadium-shots-indicator');
            
            for (let i = 0; i < totalShots; i++) {
                shotsIndicator.innerHTML += `<div class="shot-dot" id="shot-dot-${i}"></div>`;
            }

            const handleShot = (e) => {
                if (!ball || !keeper) return; // Safety check

                ball.textContent = '⚽'; 
                ball.style.fontSize = '25px'; 

                if (shotsTaken >= totalShots) return;
                goal.removeEventListener('click', handleShot);
                instructions.textContent = '...';

                const rect = goal.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const keeperPositions = [-80, 0, 80];
                const randomPos = keeperPositions[Math.floor(Math.random() * keeperPositions.length)];
                keeper.style.left = `calc(50% + ${randomPos}px)`;

                ball.style.bottom = `${(rect.height - y) + (gameBoard.clientHeight - rect.height)}px`;
                ball.style.left = `${(x / rect.width) * 100}%`;
                ball.style.transform = `translateX(-50%) scale(0.5)`;

                setTimeout(() => {
                    const goalThird = rect.width / 3;
                    const shotPosition = x < goalThird ? -80 : (x > goalThird * 2 ? 80 : 0);
                    
                    const dot = document.getElementById(`shot-dot-${shotsTaken}`);
                    if (shotPosition !== randomPos) {
                        playSound(correctSound);
                        playerScore++;
                        instructions.textContent = '⚽ هــــدف!';
                        dot.classList.add('goal');
                    } else {
                        playSound(incorrectSound);
                        keeperScore++;
                        instructions.textContent = '🧤 تصدى لها الحارس!';
                        dot.classList.add('saved');
                        keeper.textContent = '🧍‍♂️✋⚽';
                    }

                    shotsTaken++;
                    playerScoreDisplay.textContent = `أنت: ${playerScore}`;
                    keeperScoreDisplay.textContent = `الحارس: ${keeperScore}`;

                    if (shotsTaken >= totalShots) {
                        endStadiumGame();
                    } else {
                        resetShot();
                    }
                }, 600);
            };
            
            const resetShot = () => {
                setTimeout(() => {
                    if (!ball || !keeper) return; // Safety check
                    keeper.textContent = '🧍‍♂️✋';
                    ball.textContent = '🏃‍♂️⚽';
                    ball.style.fontSize = '35px';
                    ball.style.transition = 'none';
                    ball.style.bottom = '15px';
                    ball.style.left = '50%';
                    ball.style.transform = 'translateX(-50%) scale(1)';
                    keeper.style.left = '50%';

                    setTimeout(() => {
                        ball.style.transition = 'all 0.5s cubic-bezier(0.25, 1, 0.5, 1)';
                        instructions.textContent = `التسديدة ${shotsTaken + 1}/${totalShots}. انقر على المرمى!`;
                        goal.addEventListener('click', handleShot);
                    }, 50);
                }, 1000);
            };

           const endStadiumGame = () => {
                const wasAlreadyCompleted = gameState.answeredQuestions.has('stadium-game-completed');
                
                // نسجل أن اللعبة اكتملت بغض النظر عن النتيجة
                gameState.answeredQuestions.add('stadium-game-completed');

                let title, message;
                if (playerScore > keeperScore) {
                    title = '🏆 فوز رائع!';
                    
                    // نتحقق إذا كانت هذه هي المرة الأولى للفوز
                    if (!wasAlreadyCompleted) {
                        message = `لقد فزت بنتيجة ${playerScore} - ${keeperScore}. تم إضافة 5 نقاط إلى رصيدك!`;
                        gameState.score += 5;
                        updatePlayerStats();
                        updatePlayerScore(gameState.uniquePlayerId, gameState.score);
                    } else {
                        message = `لقد فزت مجدداً بنتيجة ${playerScore} - ${keeperScore}. لعب رائع! (لا يتم إضافة نقاط جديدة للعب المتكرر).`;
                    }

                } else {
                    title = '🥅 محاولة جيدة!';
                    message = `انتهت المباراة بالتعادل أو الخسارة. حظاً أوفر في المرة القادمة!`;
                }
                
                saveGameState();
                
                setTimeout(() => {
                    showModal(title, message + "<br><br>استعد الآن لتحدي الذاكرة!", () => renderMemoryGame());
                }, 1500);
            };
            goal.addEventListener('click', handleShot);
        }
        // ========== نهاية كود لعبة الملعب ==========

        // ========== بداية كود لعبة الذاكرة ==========
        // ========== بداية كود لعبة الذاكرة ==========
        function renderMemoryGame() {
            const sceneElement = document.getElementById('memory-game-scene');
            document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
            sceneElement.classList.remove('hidden');
            gameState.currentScene = 'memory-game';
            saveGameState();

            const cardEmojis = shuffleArray(collegesData).slice(0, 8).map(c => c.emoji);
            const gameCards = shuffleArray([...cardEmojis, ...cardEmojis]);

            let gridHTML = '';
            gameCards.forEach(emoji => {
                gridHTML += `
                    <div class="memory-card" data-emoji="${emoji}">
                        <div class="card-face card-front"></div>
                        <div class="card-face card-back">${emoji}</div>
                    </div>`;
            });

            sceneElement.innerHTML = `
                <div class="scene-content">
                    <h2 class="memory-game-title">تحدي الذاكرة!</h2>
                    <p style="text-align:center; margin-bottom: 20px;">استعد! سيتم عرض البطاقات لمدة 4 ثوانٍ...</p>
                    <div class="memory-grid">${gridHTML}</div>
                </div>`;
                
            const grid = sceneElement.querySelector('.memory-grid');
            const allCards = sceneElement.querySelectorAll('.memory-card');
            let flippedCards = [];
            let matchedPairs = 0;
            let lockBoard = true; // --- نبدأ واللوحة مقفلة

            // --- الكود الجديد يبدأ هنا ---

            // 1. عرض كل البطاقات فوراً عند بدء اللعبة
            allCards.forEach(card => card.classList.add('flipped'));

            // 2. بعد 4 ثوانٍ، يتم إخفاء جميع البطاقات
            setTimeout(() => {
                allCards.forEach(card => card.classList.remove('flipped'));
                
                // تحديث الرسالة
                sceneElement.querySelector('p').textContent = 'ابحث عن أزواج الرموز المتشابهة لكليات الجامعة.';

                // 3. ننتظر انتهاء حركة الإخفاء (600ms) ثم نسمح باللعب
                setTimeout(() => {
                    lockBoard = false;
                }, 600); // هذه المدة يجب أن تطابق مدة الانتقال في CSS
                
            }, 4000); // 4 ثوانٍ

            // --- الكود الجديد ينتهي هنا ---

            const handleCardClick = (e) => {
                const clickedCard = e.target.closest('.memory-card');
                // الآن هذا السطر سيمنع اللعب خلال فترة العرض الأولية
                if (lockBoard || !clickedCard || clickedCard.classList.contains('flipped')) return;

                clickedCard.classList.add('flipped');
                flippedCards.push(clickedCard);

                if (flippedCards.length === 2) {
                    lockBoard = true;
                    checkForMatch();
                }
            };

            const checkForMatch = () => {
                const [cardOne, cardTwo] = flippedCards;
                const isMatch = cardOne.dataset.emoji === cardTwo.dataset.emoji;

                if (isMatch) {
                    disableCards();
                } else {
                    unflipCards();
                }
            };
            
            const disableCards = () => {
                playSound(correctSound);
                flippedCards.forEach(card => {
                    card.classList.add('matched');
                });
                matchedPairs++;
                resetTurn();
                if (matchedPairs === cardEmojis.length) {
                    endMemoryGame();
                }
            };

            const unflipCards = () => {
                setTimeout(() => {
                    playSound(incorrectSound);
                    flippedCards.forEach(card => card.classList.remove('flipped'));
                    resetTurn();
                }, 1000);
            };

            const resetTurn = () => {
                flippedCards = [];
                lockBoard = false;
            };

            const endMemoryGame = () => {
                setTimeout(() => {
                    showModal('🧠 ذاكرة قوية!', 'لقد أتممت تحدي الذاكرة بنجاح. أنت الآن عائد إلى الخريطة.', () => renderScene('map'));
                }, 500);
            };
            
            grid.addEventListener('click', handleCardClick);
        }
        // ========== نهاية كود لعبة الذاكرة ==========
        // ========== نهاية كود لعبة الذاكرة ==========

        document.body.addEventListener('click', unlockAudio, { once: true });
        
        function getUrlsForNextScenes(sceneId, questionIndex = 0) {
            const urls = [];
            const sceneData = gameData[sceneId];
            if (Array.isArray(sceneData)) {
                for (let i = questionIndex + 1; i < Math.min(questionIndex + 3, sceneData.length); i++) {
                    if (sceneData[i] && sceneData[i].image) urls.push(sceneData[i].image);
                }
            } else if (sceneData && sceneData.nextScene) {
                const nextSceneIds = Object.values(sceneData.nextScene);
                nextSceneIds.forEach(id => {
                    const nextSceneData = gameData[id];
                    if (Array.isArray(nextSceneData) && nextSceneData[0] && nextSceneData[0].image) {
                        urls.push(nextSceneData[0].image);
                    }
                });
            }
            return urls;
        }

        preloadImage('all_q.webp');
        preloadImage('hares 1.webp');
        preloadImage('library_question.webp');

        populateFacultiesList();
        populateGuideSelection();
        restoreGameSession();
    });
</script>   
     
</body>
</html>
