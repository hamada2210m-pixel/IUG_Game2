<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رحلتي في الإسلامية</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS remains unchanged */
        :root {
            --primary-color: #006633;
            --primary-dark: #004422;
            --secondary-color: #fdd835;
            --light-bg: #e6f3ee;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --info-color: #17a2b8;
            --font-family: 'Cairo', sans-serif;
            --text-dark: #333;
            --text-light: #555;
            --white-color: #fff;
            --border-radius-main: 15px;
        }

        body {
            font-family: var(--font-family);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--text-dark);
            padding: 10px;
            box-sizing: border-box;
            background-image: url('Ferst.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(240, 244, 248, 0.85);
            z-index: -1;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        #landing-screen {
            background-color: transparent;
            padding: 30px 40px;
            border-radius: 0;
            box-shadow: none;
            text-align: center;
            animation: fadeInUp 0.6s ease-out;
            width: 100%;
        }

        .logo {
            max-width: 150px;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 32px;
            line-height: 1.4;
            font-weight: 700;
        }

        .subtitle {
            font-size: 18px;
            color: var(--text-light);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .features-grid {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
        }

        .feature-card {
            background-color: var(--white-color);
            padding: 25px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: calc(33.33% - 20px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .feature-card .icon {
            font-size: 48px;
            color: var(--primary-color);
            display: block;
            margin-bottom: 15px;
        }

        .feature-card h3 {
            color: var(--primary-color);
            font-size: 20px;
            margin-bottom: 10px;
        }

        .feature-card p {
            font-size: 14px;
            color: #777;
            line-height: 1.5;
            margin: 0;
        }

        #start-screen {
            background-color: var(--white-color);
            padding: 30px 40px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            animation: fadeInUp 0.6s ease-out;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: var(--font-family);
        }

        .action-button {
            width: 100%;
            max-width: 350px;
            padding: 15px;
            border: none;
            border-radius: 30px;
            background-color: var(--primary-color);
            color: var(--white-color);
            font-size: 18px;
            font-weight: bold;
            font-family: var(--font-family);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }

        .action-button:hover {
            background-color: var(--primary-dark);
            transform: scale(1.02);
        }

        .action-button:disabled {
            background-color: var(--text-light);
            cursor: not-allowed;
        }
        
        .btn-icon {
            transform: scaleX(-1);
        }

        .hidden {
            display: none !important;
        }

        #player-stats {
            position: fixed;
            top: 15px;
            left: 15px;
            background-color: rgba(0, 68, 34, 0.9);
            color: var(--white-color);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #player-score {
            background-color: var(--secondary-color);
            color: var(--text-dark);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .game-stage {
            background-color: var(--white-color);
            padding: 0;
            border-radius: var(--border-radius-main);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        .scene-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .scene-content {
            padding: 25px;
        }

        .scene-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 20px;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }

        .option-btn {
            position: relative;
            padding: 15px 10px;
            border: 2px solid var(--primary-color);
            background-color: var(--white-color);
            color: var(--primary-color);
            font-size: 16px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }

        .option-btn:hover {
            background-color: var(--light-bg);
            transform: translateY(-2px);
        }

        .option-btn.correct {
            background-color: var(--correct-color);
            color: var(--white-color);
            border-color: var(--correct-color);
        }
        .option-btn.correct:hover {
            background-color: var(--correct-color);
        }
        .option-btn.incorrect {
            background-color: var(--incorrect-color);
            color: var(--white-color);
            border-color: var(--incorrect-color);
        }
        .option-btn.incorrect:hover {
            background-color: var(--incorrect-color);
        }
        
        .option-btn.correct::before, .option-btn.incorrect::before {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
        }

        .option-btn.correct::before { content: '✓'; }
        .option-btn.incorrect::before { content: '✗'; }

        .feedback-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: var(--white-color);
            display: none;
        }

        .feedback-message.correct { background-color: var(--correct-color); }
        .feedback-message.incorrect { background-color: var(--incorrect-color); }
        .feedback-message.info { background-color: var(--info-color); }

        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            direction: rtl;
        }

        .modal-content {
            background-color: var(--white-color);
            padding: 30px;
            border-radius: var(--border-radius-main);
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: slide-down 0.4s ease-out;
        }

        @keyframes slide-down {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate3d(0, 30px, 0); }
            to { opacity: 1; transform: translate3d(0, 0, 0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .modal-content p {
            color: var(--text-light);
            font-size: 16px;
        }
        
        #map-scene .options-container .option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 18px;
            padding: 25px 15px;
        }

        .map-icon {
            font-size: 36px;
            margin-bottom: 5px;
        }

        .progress-bar-container {
            width: 90%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            height: 10px;
            margin: 10px auto 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        .progress-bar {
            height: 100%;
            width: 0;
            background-color: var(--primary-color);
            transition: width 0.5s ease;
        }

        #faculties-scene .options-container,
        #exchange-scene .options-container {
            grid-template-columns: 1fr;
            max-width: 400px;
            margin: 25px auto 0;
        }

        #faculties-scene .option-btn,
        #exchange-scene .option-btn {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 20px;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #faculties-scene .option-btn:hover,
        #exchange-scene .option-btn:hover {
            transform: scale(1.03);
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        #faculties-scene .option-btn span,
        #exchange-scene .option-btn span {
            font-size: 30px;
        }
        
        @media (max-width: 600px) {
            .options-container {
                grid-template-columns: 1fr;
            }
            #player-stats {
                font-size: 14px;
                gap: 10px;
                padding: 8px 12px;
            }
            .features-grid {
                flex-direction: column;
                align-items: center;
            }
            .feature-card {
                width: 90%;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>

    <audio id="correct-sound" src="correct.mp3"></audio>
    <audio id="incorrect-sound" src="funny.mp3"></audio>
    <audio id="transition-sound" src="turning.mp3"></audio>

    <div class="game-container">
        <div id="landing-screen">
            <img src="logo.png" alt="شعار الجامعة الإسلامية" class="logo">
            <h1>رحلتك نحو المعرفة والتميز تبدأ الآن</h1>
            <p class="subtitle">تطلق الجامعة الإسلامية بغزة مسابقة تفاعلية فريدة لطلبة الثانوية العامة، استعد لتحدي معلوماتك والفوز بجوائز قيمة.</p>
            <div class="features-grid">
                <div class="feature-card">
                    <span class="icon">🎓</span>
                    <h3>حوّلها إلى منحة</h3>
                    <p>حوّل أرباحك لمنحة دراسية حقيقية عند التحاقك بالجامعة.</p>
                </div>
                <div class="feature-card">
                    <span class="icon">💰</span>
                    <h3>اربح جوائز فورية</h3>
                    <p>اجمع "جنيهات" إلكترونية مع كل إجابة صحيحة تضاف إلى رصيدك.</p>
                </div>
                <div class="feature-card">
                    <span class="icon">🏆</span>
                    <h3>تحديات ممتعة</h3>
                    <p>أجب عن أسئلة شيقة في مجالات متنوعة واختر تخصصك.</p>
                </div>
            </div>
            <button id="show-register-btn" class="action-button">
                <span class="btn-icon">📅</span> لا تفوّت الفرصة - سجّل الآن!
            </button>
        </div>

        <div id="start-screen" class="hidden">
            <img src="logo.png" alt="شعار الجامعة الإسلامية" class="logo">
            <h1>أهلاً بك في رحلتك الافتراضية</h1>
            <p>استكشف الجامعة الإسلامية، أجب عن التحديات، واربح منحة دراسية حقيقية!</p>
            <form id="player-form">
                <div class="form-group">
                    <label for="name">الاسم الكامل:</label>
                    <input type="text" id="name" placeholder="مثال: أحمد علي" required>
                </div>
                <div class="form-group">
                    <label for="phone">رقم الجوال:</label>
                    <input type="tel" id="phone" placeholder="مثال: 059xxxxxxx" required>
                </div>
                <div class="form-group">
                    <label for="tawjihi-year">سنة التوجيهي:</label>
                    <input type="number" id="tawjihi-year" placeholder="مثال: 2024" required>
                </div>
                <button type="submit" class="action-button">ابدأ الرحلة!</button>
            </form>
        </div>

        <div id="game-scene" class="hidden">
            <div id="player-stats" class="hidden">
                <span id="player-name"></span>
                <span id="player-score"></span>
            </div>

            <div id="gate-scene" class="game-stage hidden"></div>
            <div id="map-scene" class="game-stage hidden">
                <div class="scene-content">
                    <h2 class="scene-title">خريطة الجامعة</h2>
                    <p>لقد دخلت الحرم الجامعي! اختر وجهتك التالية لاستكمال رحلتك.</p>
                    <div class="options-container">
                        <button class="option-btn" data-destination="library"><span class="map-icon">📚</span> المكتبة المركزية</button>
                        <button class="option-btn" data-destination="cafeteria"><span class="map-icon">☕</span> الكافتيريا</button>
                        <button class="option-btn" data-destination="faculties"><span class="map-icon">🏢</span> الكليات</button>
                        <button class="option-btn" data-destination="grants"><span class="map-icon">💰</span> المنح والمساعدات</button>
                        <button class="option-btn" data-destination="hospital"><span class="map-icon">🏥</span> المستشفى الجامعي</button>
                        <button class="option-btn" data-destination="admission"><span class="map-icon">📝</span> القبول والتسجيل</button>
                        <button class="option-btn" data-destination="studentaffairs"><span class="map-icon">🧑‍🎓</span> شؤون الطلبة</button>
                        <button class="option-btn" data-destination="conference"><span class="map-icon">🏛️</span> قاعة المؤتمرات</button>
                        <button class="option-btn" data-destination="stadium"><span class="map-icon">🏟️</span> ملعب الجامعة</button>
                        <button class="option-btn" data-destination="exchange"><span class="map-icon">🌍</span> التبادل الأكاديمي</button>
                        <button class="option-btn" data-destination="certificate" style="grid-column: 1 / -1;"><span class="map-icon">📜</span> الحصول على الشهادة</button>
                    </div>
                </div>
            </div>
            <div id="faculties-scene" class="game-stage hidden"></div>
            <div id="tf_questions-scene" class="game-stage hidden"></div>
            <div id="mc_questions-scene" class="game-stage hidden"></div>
            <div id="exchange-scene" class="game-stage hidden"></div>
            <div id="exchange_tf_questions-scene" class="game-stage hidden"></div>
            <div id="exchange_mc_questions-scene" class="game-stage hidden"></div>
            <div id="library-scene" class="game-stage hidden"></div>
            
            <div id="end-scene" class="game-stage hidden">
                <div class="scene-content">
                    <h2 class="scene-title">🎉 تهانينا! 🎉</h2>
                    <img src="https://placehold.co/400x250/28a745/FFFFFF?text=شهادة+شكر" alt="شهادة مشاركة" class="scene-image" style="max-width: 100%; border-radius: 10px; margin-bottom: 20px;">
                    <p id="final-message" style="font-size: 18px; line-height: 1.6;"></p>
                    <button id="share-btn" class="action-button">مشاركة على وسائل التواصل</button>
                    <button id="restart-btn" class="action-button" style="margin-top: 10px; background-color: var(--text-light);">ابدأ من جديد</button>
                </div>
            </div>
        </div>
    </div>

    <div id="feedback-modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <p id="modal-text"></p>
            <button id="modal-close-btn" class="action-button">متابعة</button>
        </div>
    </div>

    <script>
        // JS remains the same until the event listener
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby2RjbdyISPTbhfR8h-lE41eY0lEWEOxZevGyTMxNbpY2zTmRzWa3DEAd5Dc6O72GgtMA/exec';
        function registerPlayer(name, phone, year) {
            const formData = new FormData();
            formData.append('action', 'register');
            formData.append('name', name);
            formData.append('phone', phone);
            formData.append('year', year);
            return fetch(SCRIPT_URL, { method: 'POST', body: formData }).then(response => response.json());
        }
        function updatePlayerScore(uniqueId, score) {
            if (!uniqueId) {
                console.error("Attempted to update score without a uniqueId.");
                return;
            }
            const formData = new FormData();
            formData.append('action', 'updateScore');
            formData.append('uniqueId', uniqueId);
            formData.append('score', score);
            fetch(SCRIPT_URL, { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        console.log(`Score updated to: ${score}`);
                    } else {
                        console.error('Error updating score:', data.message);
                    }
                })
                .catch(error => console.error('Error in update fetch:', error));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const gameData = {
                'gate': { id: 'gate_q1', image: 'hares 1.png', question: 'أهلاً بك في الجامعة الإسلامية! للدخول، أجب عن السؤال التالي: في أي عام تأسست الجامعة؟', options: { '1978': '1978', '1982': '1982', '1960': '1960', '1990': '1990' }, correctAnswer: '1978', points: 1, correctFeedback: 'رائع! لقد حصلت على جنيه واحد. البوابة الآن مفتوحة أمامك!', incorrectFeedback: 'إجابة غير صحيحة. حاول مرة أخرى!' },
                'library': [ { id: 'library_q1', image: 'library_question.png', question: 'تضم مكتبتنا كنزاً معرفياً ضخماً. كم عدد المراجع الإلكترونية التي توفرها؟', options: { '100k': 'أكثر من 100 ألف مرجع الكتروني', '150k': 'أكثر من 150 ألف مرجع الكتروني', '50k': 'أقل من 50 ألف مرجع الكتروني', '200k': 'أكثر من 200 ألف مرجع الكتروني' }, correctAnswer: '150k', points: 1, correctFeedback: 'إجابة ممتازة! معرفتك دقيقة. لقد ربحت جنيهًا واحدًا. لننتقل للتحدي التالي.', incorrectFeedback: 'حاول مرة أخرى! المعرفة قوة.' }, { id: 'library_q2', image: 'library_question_2.png', question: 'هل توفر المكتبة قاعات هادئة ومخصصة للدراسة؟', options: { 'yes': 'نعم، توفر قاعات هادئة', 'no': 'لا، المكتبة للكتب فقط' }, correctAnswer: 'yes', points: 1, correctFeedback: 'بالتأكيد! راحتك أثناء الدراسة تهمنا. لقد ربحت جنيهًا واحدًا إضافيًا.', incorrectFeedback: 'إجابة غير صحيحة. المكتبة مكان مثالي للدراسة.' }, { id: 'library_q3', image: 'library_question_3.png', question: 'كيف تساعدك المكتبة في أبحاثك الجامعية؟', options: { 'resources': 'توفر مصادر ومراجع متنوعة', 'writes_for_you': 'تكتب البحث بدلاً عنك' }, correctAnswer: 'resources', points: 1, correctFeedback: 'صحيح! المكتبة هي شريكك الأول في البحث العلمي. ربحت جنيهًا واحدًا.', incorrectFeedback: 'إجابة غير دقيقة. المكتبة تدعمك بالمصادر لا بالقيام بالعمل عنك.' }, { id: 'library_q4', image: 'library_question_4.png', question: 'هل توفر المكتبة مواد رقمية يمكن الوصول إليها عن بعد؟', options: { 'yes_ebooks': 'نعم، توفر كتباً إلكترونية', 'no_digital': 'لا، كل المواد ورقية فقط' }, correctAnswer: 'yes_ebooks', points: 1, correctFeedback: 'أحسنت! يمكنك الوصول لكنز معرفي من أي مكان. لقد ربحت آخر جنيه في هذه المرحلة.', incorrectFeedback: 'إجابة غير صحيحة. العصر الرقمي في قلب مكتبتنا.' } ],
                'faculties': { image: 'first_faculties_q.png', question: 'اختر نوع التحدي الذي تود خوضه هنا:', options: { 'tf_questions': '<span class="icon">✔️❌</span> أسئلة صح وخطأ', 'mc_questions': '<span class="icon">❓</span> أسئلة اختيار من متعدد' }, correctAnswer: null, points: 0, nextScene: { 'tf_questions': 'tf_questions', 'mc_questions': 'mc_questions' } },
                'tf_questions': [ { id: 'tf_q1', image: 'all_q.png', question: 'تأسست الجامعة الإسلامية بغزة عام 1978.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'tf_q2', image: 'all_q.png', question: 'الجامعة لديها 11 كلية.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'tf_q3', image: 'all_q.png', question: 'كلية الطب تأسست عام 2006.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'tf_q4', image: 'all_q.png', question: 'كلية تكنولوجيا المعلومات أُسست قبل كلية التجارة.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'incorrect', points: 1, correctFeedback: 'خطأ! كلية التجارة تأسست عام 1981، بينما تكنولوجيا المعلومات تأسست عام 2005. ربحت جنيهاً.' }, { id: 'tf_q5', image: 'all_q.png', question: 'الجامعة تقدم شهادات دكتوراة (PhD) في الإدارة، الاقتصاد، الهندسة، الفنون، وتكنولوجيا المعلومات.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'tf_q6', image: 'all_q.png', question: 'الجامعة الأولى على مستوى غزة من حيث الترتيب العالمي.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'tf_q7', image: 'all_q.png', question: 'في كلية الطب، يجب على الطالب نشر بحث علمي في مجلة محكّمة كجزء من متطلبات التخرج.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'tf_q8', image: 'all_q.png', question: 'كلية الطب هي المركز الوحيد المعتمد لإجراء امتحانات IFOM داخل غزة.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'tf_q9', image: 'all_q.png', question: 'الجامعة مقرها فقط في مدينة غزة، ولا يوجد لها فروع أخرى.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'incorrect', points: 1, correctFeedback: 'خطأ! للجامعة فروع في وسط قطاع غزة (الزهراء) وجنوبه. ربحت جنيهاً.' }, { id: 'tf_q10', image: 'all_q.png', question: 'الجامعة عضو في الاتحاد الدولي للجامعات ومجموعة جامعات البحر الأبيض المتوسط.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'tf_q11', image: 'all_q.png', question: 'لدى الجامعة أكثر من 20 مركزًا ومعهدًا بحثيًا.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'tf_q12', image: 'all_q.png', question: 'تأسست كلية التربية قبل كلية الشريعة والأصول.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'incorrect', points: 1, correctFeedback: 'خطأ! كلية الشريعة والأصول تأسست عام 1978، بينما كلية التربية تأسست عام 1980. ربحت جنيهاً.' }, { id: 'tf_q13', image: 'all_q.png', question: 'الجامعة رائدة في خدمات البحث والتعليم في غزة منذ أكثر من 38 عامًا.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 } ],
                'mc_questions': [ { id: 'mc_q1', image: 'all_q.png', question: 'كم عدد الكليات في الجامعة الإسلامية بغزة؟', options: { '9': '9', '10': '10', '11': '11', '12': '12' }, correctAnswer: '11', points: 1 }, { id: 'mc_q2', image: 'all_q.png', question: 'أي من الكليات التالية ليست من كليات الجامعة؟', options: { 'الطب': 'الطب', 'الهندسة': 'الهندسة', 'الفنون': 'الفنون', 'it': 'تكنولوجيا المعلومات' }, correctAnswer: 'الفنون', points: 1 }, { id: 'mc_q3', image: 'all_q.png', question: 'متى تأسست كلية الطب بالجامعة؟', options: { '1980': '1980', '1993': '1993', '2005': '2005', '2006': '2006' }, correctAnswer: '2006', points: 1 }, { id: 'mc_q4', image: 'all_q.png', question: 'أي من التالي يصف مكانة الجامعة على مستوى غزة؟', options: { 'الثالثة': 'الثالثة', 'الرابعة': 'الرابعة', 'الثانية': 'الثانية', 'الأولى': 'الأولى' }, correctAnswer: 'الأولى', points: 1 }, { id: 'mc_q5', image: 'all_q.png', question: 'في أي كلية يجب على الطالب اجتياز امتحاني IFOM-BSE وIFOM-CSE للتخرج؟', options: { 'الهندسة': 'الهندسة', 'الطب': 'الطب', 'it': 'تكنولوجيا المعلومات', 'التربية': 'التربية' }, correctAnswer: 'الطب', points: 1 }, { id: 'mc_q6', image: 'all_q.png', question: 'من بين هذه الكليات، أيها تأسست أولاً؟', options: { 'تكنولوجيا المعلومات (2005)': 'تكنولوجيا المعلومات (2005)', 'التجارة (1981)': 'التجارة (1981)', 'التربية (1980)': 'التربية (1980)', 'الطب (2006)': 'الطب (2006)' }, correctAnswer: 'التربية (1980)', points: 1 }, { id: 'mc_q7', image: 'all_q.png', question: 'أي من الاتحادات التالية الجامعة عضو فيها؟', options: { 'رابطة الجامعات الأمريكية': 'رابطة الجامعات الأمريكية', 'روسيا الجامعات الإسلامية': 'روسيا الجامعات الإسلامية', 'اتحاد البحر المتوسط لجامعات': 'اتحاد البحر المتوسط لجامعات', 'رابطة الجامعات الصينية': 'رابطة الجامعات الصينية' }, correctAnswer: 'اتحاد البحر المتوسط لجامعات', points: 1 }, { id: 'mc_q8', image: 'all_q.png', question: 'كم عدد المراكز والمعاهد البحثية بالجامعة؟', options: { 'أقل من 10': 'أقل من 10', 'حوالي 15': 'حوالي 15', 'أكثر من 20': 'أكثر من 20', '30 فقط': '30 فقط' }, correctAnswer: 'أكثر من 20', points: 1 }, { id: 'mc_q9', image: 'all_q.png', question: 'ما السنة التي تقدّمت فيها الجامعة 304 مرتبة في الترتيب العالمي (Webometrics)؟', options: { '2020': '2020', '2021': '2021', '2022': '2022', '2023': '2023' }, correctAnswer: '2022', points: 1 }, { id: 'mc_q10', image: 'all_q.png', question: 'ما الترتيب العربي للجامعة حسب Webometrics؟', options: { '50': '50', '77': '77', '100': '100', '125': '125' }, correctAnswer: '77', points: 1 }, { id: 'mc_q11', image: 'all_q.png', question: 'الجامعة توصّلت إلى شراكة بحثية مع...؟', options: { 'جامعة هارفارد': 'جامعة هارفارد', 'جامعة لندن للعلوم': 'جامعة لندن للعلوم', 'معهد التربية بجامعة UCL': 'معهد التربية بجامعة UCL', 'جامعة كامبريدج': 'جامعة كامبريدج' }, correctAnswer: 'معهد التربية بجامعة UCL', points: 1 }, { id: 'mc_q12', image: 'all_q.png', question: 'أي من التالي يشكّل جزءًا من أهداف كلية الطب؟', options: { 'إعداد أطباء تلبية لاحتياجات المجتمع': 'إعداد أطباء تلبية لاحتياجات المجتمع', 'إعداد مهندسين مدنيين': 'إعداد مهندسين مدنيين', 'تطوير برامج الإدارة فقط': 'تطوير برامج الإدارة فقط', 'نشر الفكر الفلسفي فقط': 'نشر الفكر الفلسفي فقط' }, correctAnswer: 'إعداد أطباء تلبية لاحتياجات المجتمع', points: 1 }, { id: 'mc_q13', image: 'all_q.png', question: 'من كان أول عميد لكلية الطب في الجامعة الإسلامية بغزة؟', options: { 'د. مفيد المخللاتي': 'د. مفيد المخللاتي', 'د. فاضل نعيم': 'د. فاضل نعيم', 'د. أنور شيخ خليل': 'د. أنور شيخ خليل', 'د. نصر المزين': 'د. نصر المزين' }, correctAnswer: 'د. مفيد المخللاتي', points: 1 }, { id: 'mc_q14', image: 'all_q.png', question: 'أي من التالي يعبّر عن وصف الجامعة بأنها "بيت الطالب الفلسطيني"؟', options: { 'جامعة فلسطينية خاصة': 'جامعة فلسطينية خاصة', 'جامعة مستقلة عريقة في خدمة الطلبة الفلسطينيين': 'جامعة مستقلة عريقة في خدمة الطلبة الفلسطينيين', 'مؤسسة تعليمية فقط': 'مؤسسة تعليمية فقط', 'كلية تقنية فقط': 'كلية تقنية فقط' }, correctAnswer: 'جامعة مستقلة عريقة في خدمة الطلبة الفلسطينيين', points: 1 }, { id: 'mc_q15', image: 'all_q.png', question: 'أي كلية تضم برنامج "هندسة النظم الذكية"؟', options: { 'كلية تكنولوجيا المعلومات': 'كلية تكنولوجيا المعلومات', 'كلية الهندسة': 'كلية الهندسة', 'كلية العلوم': 'كلية العلوم', 'كلية الآداب': 'كلية الآداب' }, correctAnswer: 'كلية الهندسة', points: 1 }, { id: 'mc_q16', image: 'all_q.png', question: 'أي المسارات التالية موجود ضمن "هندسة النظم الذكية"؟', options: { 'أنظمة الطاقة الذكية': 'أنظمة الطاقة الذكية', 'هندسة الطيران': 'هندسة الطيران', 'هندسة البترول': 'هندسة البترول', 'هندسة الطب الحيوي': 'هندسة الطب الحيوي' }, correctAnswer: 'أنظمة الطاقة الذكية', points: 1 }, { id: 'mc_q17', image: 'all_q.png', question: 'أيٌّ مما يلي يُعد مسارًا ضمن برنامج الهندسة المعمارية؟', options: { 'تصميم داخلي': 'تصميم داخلي', 'هندسة البحار': 'هندسة البحار', 'الهندسة الطبية': 'الهندسة الطبية', 'الكيمياء الحيوية': 'الكيمياء الحيوية' }, correctAnswer: 'تصميم داخلي', points: 1 }, { id: 'mc_q18', image: 'all_q.png', question: 'أي درجة دكتوراه تُطرح في كلية الهندسة؟', options: { 'دكتوراه هندسة الحاسوب': 'دكتوراه هندسة الحاسوب', 'دكتوراه طب الأسنان': 'دكتوراه طب الأسنان', 'دكتوراه الإعلام': 'دكتوراه الإعلام', 'دكتوراه الترجمة': 'دكتوراه الترجمة' }, correctAnswer: 'دكتوراه هندسة الحاسوب', points: 1 }, { id: 'mc_q19', image: 'all_q.png', question: 'أيٌّ من المختبرات التالية مُدرج ضمن مختبرات قسم الهندسة الكهربائية؟', options: { 'مختبر المعالجات والمتحكمات الدقيقة': 'مختبر المعالجات والمتحكمات الدقيقة', 'مختبر الأحياء الدقيقة': 'مختبر الأحياء الدقيقة', 'مختبر التشريح': 'مختبر التشريح', 'مختبر الصحافة التلفزيونية': 'مختبر الصحافة التلفزيونية' }, correctAnswer: 'مختبر المعالجات والمتحكمات الدقيقة', points: 1 }, { id: 'mc_q20', image: 'all_q.png', question: 'أي برنامج "بكالوريوس" يوجد في كلية الآداب؟', options: { 'الإعلام الرقمي': 'الإعلام الرقمي', 'هندسة الذكاء الاصطناعي': 'هندسة الذكاء الاصطناعي', 'التمريض': 'التمريض', 'الطب البشري': 'الطب البشري' }, correctAnswer: 'الإعلام الرقمي', points: 1 }, { id: 'mc_q21', image: 'all_q.png', question: 'أي مسمّى صحيح لتخصص ضمن "الصحافة والإعلام" بكلية الآداب؟', options: { 'علاقات عامة وإعلان': 'علاقات عامة وإعلان', 'تصميم ميكاترونيكس': 'تصميم ميكاترونيكس', 'هندسة كيميائية': 'هندسة كيميائية', 'نظم معلومات صحية': 'نظم معلومات صحية' }, correctAnswer: 'علاقات عامة وإعلان', points: 1 }, { id: 'mc_q22', image: 'all_q.png', question: 'أي خيار يُمثّل فرعيًا موجودًا في قسم اللغة العربية بكلية الآداب؟', options: { 'تدقيق لغوي': 'تدقيق لغوي', 'جراحة عامة': 'جراحة عامة', 'هندسة موانئ': 'هندسة موانئ', 'فيزياء طبية': 'فيزياء طبية' }, correctAnswer: 'تدقيق لغوي', points: 1 }, { id: 'mc_q23', image: 'all_q.png', question: 'أي "مساق" وارد في خطة برنامج اللغة الإنجليزية/فرعي ترجمة (سنة رابعة – فصل ثانٍ)؟', options: { 'الترجمة الفورية': 'الترجمة الفورية', 'فيزياء الكم': 'فيزياء الكم', 'تشريح الإنسان': 'تشريح الإنسان', 'مقاومة المواد': 'مقاومة المواد' }, correctAnswer: 'الترجمة الفورية', points: 1 }, { id: 'mc_q24', image: 'all_q.png', question: 'أي مركز يتبع كلية الآداب؟', options: { 'مركز التاريخ الشفوي والتراث الفلسطيني': 'مركز التاريخ الشفوي والتراث الفلسطيني', 'مركز طب المناطق الحارة': 'مركز طب المناطق الحارة', 'مركز تحلية المياه': 'مركز تحلية المياه', 'مركز الذكاء الاصطناعي الطبي': 'مركز الذكاء الاصطناعي الطبي' }, correctAnswer: 'مركز التاريخ الشفوي والتراث الفلسطيني', points: 1 }, { id: 'mc_q25', image: 'all_q.png', question: 'أيٌّ من الآتي "برنامج/تخصص" بكالوريوس في كلية العلوم؟', options: { 'التكنولوجيا الحيوية': 'التكنولوجيا الحيوية', 'هندسة البترول': 'هندسة البترول', 'طب الأسنان': 'طب الأسنان', 'علوم سياسية': 'علوم سياسية' }, correctAnswer: 'التكنولوجيا الحيوية', points: 1 }, { id: 'mc_q26', image: 'all_q.png', question: 'أي عبارة صحيحة تخص قسم الرياضيات بكلية العلوم؟', options: { 'أطلق أول برنامج دكتوراه في الرياضيات بقطاع غزة عام 2014': 'أطلق أول برنامج دكتوراه في الرياضيات بقطاع غزة عام 2014', 'لا يطرح برامج دراسات عليا': 'لا يطرح برامج دراسات عليا', 'أول ماجستير بدأ عام 2022': 'أول ماجستير بدأ عام 2022', 'يمنح فقط بكالوريوس': 'يمنح فقط بكالوريوس' }, correctAnswer: 'أطلق أول برنامج دكتوراه في الرياضيات بقطاع غزة عام 2014', points: 1 }, { id: 'mc_q27', image: 'all_q.png', question: 'أين يقع "الفرع الرئيس" للجامعة بحسب الصفحة الرسمية؟', options: { 'شارع الثلاثيني – حي الرمال – غزة': 'شارع الثلاثيني – حي الرمال – غزة', 'خان يونس': 'خان يونس', 'رفح': 'رفح', 'دير البلح': 'دير البلح' }, correctAnswer: 'شارع الثلاثيني – حي الرمال – غزة', points: 1 }, { id: 'mc_q28', image: 'all_q.png', question: 'أي خدمة/منصة تظهر ضمن روابط الخدمات الإلكترونية في الواجهة الرئيسية للموقع؟', options: { 'Moodle': 'Moodle', 'Coursera': 'Coursera', 'edX': 'edX', 'Khan Academy': 'Khan Academy' }, correctAnswer: 'Moodle', points: 1 }, { id: 'mc_q29', image: 'all_q.png', question: 'أي خبر جامعي نُشر بتاريخ 9 أغسطس 2025؟', options: { 'حصول الجامعة على اعتماد لافتتاح برنامج هندسة الذكاء الاصطناعي': 'حصول الجامعة على اعتماد لافتتاح برنامج هندسة الذكاء الاصطناعي', 'افتتاح مكتبة الطب': 'افتتاح مكتبة الطب', 'تخريج دفعة 2026': 'تخريج دفعة 2026', 'اعتماد برنامج طب الأسنان': 'اعتماد برنامج طب الأسنان' }, correctAnswer: 'حصول الجامعة على اعتماد لافتتاح برنامج هندسة الذكاء الاصطناعي', points: 1 }, { id: 'mc_q30', image: 'all_q.png', question: 'أي عبارة صحيحة عن كلية الهندسة؟', options: { 'تضم قسم هندسة الحاسوب وتطرح له خطة دراسية وبرنامج ماجستير': 'تضم قسم هندسة الحاسوب وتطرح له خطة دراسية وبرنامج ماجستير', 'لا تضم أي أقسام للحاسوب': 'لا تضم أي أقسام للحاسوب', 'لا تملك مختبرات': 'لا تملك مختبرات', 'لا تقدم دراسات عليا': 'لا تقدم دراسات عليا' }, correctAnswer: 'تضم قسم هندسة الحاسوب وتطرح له خطة دراسية وبرنامج ماجستير', points: 1 }, { id: 'mc_q31', image: 'all_q.png', question: 'أيٌّ من التالي برنامج داخل كلية تكنولوجيا المعلومات؟', options: { 'الذكاء الاصطناعي وعلوم البيانات': 'الذكاء الاصطناعي وعلوم البيانات', 'إدارة المستشفيات': 'إدارة المستشفيات', 'العلوم السياسية': 'العلوم السياسية', 'الصيدلة': 'الصيدلة' }, correctAnswer: 'الذكاء الاصطناعي وعلوم البيانات', points: 1 }, { id: 'mc_q32', image: 'all_q.png', question: 'أي من "المساقات" التالية يندرج ضمن برنامج اللغة الإنجليزية/صحافة وإعلام أو فرعي ترجمة (كلية الآداب)؟', options: { 'الترجمة التجارية والأكاديمية': 'الترجمة التجارية والأكاديمية', 'مقاومة المواد': 'مقاومة المواد', 'تشريح مقارن': 'تشريح مقارن', 'أساسيات الدوائر الكهربائية': 'أساسيات الدوائر الكهربائية' }, correctAnswer: 'الترجمة التجارية والأكاديمية', points: 1 }, { id: 'mc_q33', image: 'all_q.png', question: 'أيٌّ مما يلي يعدّ "برنامج ماجستير" مذكورًا تحت كلية الآداب؟', options: { 'ماجستير الصحافة': 'ماجستير الصحافة', 'ماجستير هندسة الميكاترونيكس': 'ماجستير هندسة الميكاترونيكس', 'ماجستير التحاليل الطبية': 'ماجستير التحاليل الطبية', 'ماجستير طب الفم والأسنان': 'ماجستير طب الفم والأسنان' }, correctAnswer: 'ماجستير الصحافة', points: 1 } ],
                'exchange': { image: 'all_q.png', question: 'اختر نوع التحدي الذي تود خوضه هنا:', options: { 'exchange_tf_questions': '<span class="icon">✔️❌</span> أسئلة صح وخطأ', 'exchange_mc_questions': '<span class="icon">❓</span> أسئلة اختيار من متعدد' }, correctAnswer: null, points: 0, nextScene: { 'exchange_tf_questions': 'exchange_tf_questions', 'exchange_mc_questions': 'exchange_mc_questions' } },
                'exchange_tf_questions': [ { id: 'ex_tf_q1', image: 'all_q.png', question: 'تهتم العلاقات الخارجية في الجامعة بتوفير منح بكالوريوس، ماجستير، دكتوراه وما بعد الدكتوراه في جامعات عالمية مثل هارفارد وأوكسفورد وغيرها.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'ex_tf_q2', image: 'all_q.png', question: 'الجامعة عضو في شبكة جامعات البحر الأسود وشرق البحر المتوسط (BSEMAN).', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'ex_tf_q3', image: 'all_q.png', question: 'العلاقات الخارجية أبرمت مشاريع تبادل أكاديمي ضمن برنامج Erasmus+ مع جامعة جلاسكو وجامعة Algarve.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'ex_tf_q4', image: 'all_q.png', question: 'إحدى اتفاقيات التبادل مع جامعة جلاسكو دعمت تبادل طلبة وأعضاء هيئة تدريس ضمن فترة 2016–2019.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'ex_tf_q5', image: 'all_q.png', question: 'نظمت العلاقات الخارجية ورشة عمل خاصة بالمشاريع الأوروبية مثل Erasmus+ وTEMPUS وبرنامج المقدسي.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 }, { id: 'ex_tf_q6', image: 'all_q.png', question: 'تم الترتيب لعقد مؤتمر دولي في الأبحاث الإدارية والاقتصادية بتمويل من Erasmus+ ضمن مشروع BERC.', options: { 'correct': 'صح', 'incorrect': 'خطأ' }, correctAnswer: 'correct', points: 1 } ],
                'exchange_mc_questions': [ { id: 'ex_mc_q1', image: 'all_q.png', question: 'أياً من الخدمات التالية تتولّاها دائرة العلاقات الخارجية؟', options: { 'تأمين المنح الدراسية فقط': 'تأمين المنح الدراسية فقط', 'توفير منح دراسية دولية والتبادل الأكاديمي واستقطاب الباحثين': 'توفير منح دراسية دولية والتبادل الأكاديمي واستقطاب الباحثين', 'تنظيم الرحلات السياحية': 'تنظيم الرحلات السياحية', 'إصدار التراخيص الحكومية': 'إصدار التراخيص الحكومية' }, correctAnswer: 'توفير منح دراسية دولية والتبادل الأكاديمي واستقطاب الباحثين', points: 1 }, { id: 'ex_mc_q2', image: 'all_q.png', question: 'ما البرنامج الأوروبي الذي فتح المجال لتبادل أعضاء هيئة التدريس والطلبة مع جامعات كالاسكوتلندية والبرتغالية؟', options: { 'Horizon 2020': 'Horizon 2020', 'Erasmus+ (Key Action 1)': 'Erasmus+ (Key Action 1)', 'Marie Skłodowska-Curie': 'Marie Skłodowska-Curie', 'Erasmus Mundus': 'Erasmus Mundus' }, correctAnswer: 'Erasmus+ (Key Action 1)', points: 1 }, { id: 'ex_mc_q3', image: 'all_q.png', question: 'أي مشروع كان موجّهًا لتطوير مراكز الأبحاث الإدارية والاقتصادية والمعروف اختصاراً بـ "BERC"؟', options: { 'برنامج مد الأولويات': 'برنامج مد الأولويات', 'وثائق تبادل البحوث': 'وثائق تبادل البحوث', 'BERC بدعم من Erasmus+': 'BERC بدعم من Erasmus+', 'مشروع التواصل الثقافي': 'مشروع التواصل الثقافي' }, correctAnswer: 'BERC بدعم من Erasmus+', points: 1 }, { id: 'ex_mc_q4', image: 'all_q.png', question: 'أي من التالي صحيح حول اتفاقيات الجامعة؟', options: { 'Erasmus+ يشمل فقط البحث': 'Erasmus+ يشمل فقط البحث', 'لا يوجد تبادل طلبة مع أوروبا': 'لا يوجد تبادل طلبة مع أوروبا', 'الاتفاقيات تشمل تبادل طلاب وأكاديميين ضمن برامج دولية': 'الاتفاقيات تشمل تبادل طلاب وأكاديميين ضمن برامج دولية', 'الاتفاقيات محلية فقط': 'الاتفاقيات محلية فقط' }, correctAnswer: 'الاتفاقيات تشمل تبادل طلاب وأكاديميين ضمن برامج دولية', points: 1 }, { id: 'ex_mc_q5', image: 'all_q.png', question: 'أي من البرامج التالية نُظمت عنه ورشة تقديمية بحضور أكثر من 350 مشاركاً وأطراف من وزارة التعليم العالي؟', options: { 'Horizon Europe': 'Horizon Europe', 'Erasmus+': 'Erasmus+', 'TEMPUS': 'TEMPUS', 'برنامج النفاذ المفتوح': 'برنامج النفاذ المفتوح' }, correctAnswer: 'Erasmus+', points: 1 }, { id: 'ex_mc_q6', image: 'all_q.png', question: 'مع أي جامعة أبرمت الجامعة الإسلامية اتفاقاً ضمن مشروع Erasmus+ بعنوان ROMOR؟', options: { 'جامعة برشلونة': 'جامعة برشلونة', 'جامعة جلاسكو (University of Glasgow)': 'جامعة جلاسكو (University of Glasgow)', 'جامعة ساساري': 'جامعة ساساري', 'جامعة Algarve': 'جامعة Algarve' }, correctAnswer: 'جامعة جلاسكو (University of Glasgow)', points: 1 }, { id: 'ex_mc_q7', image: 'all_q.png', question: 'أي من الجامعات التالية لم يتم ذكرها ضمن اتفاقيات التبادل الأكاديمي؟', options: { 'جامعة Siegen – ألمانيا': 'جامعة Siegen – ألمانيا', 'جامعة Barcelona – إسبانيا': 'جامعة Barcelona – إسبانيا', 'جامعة هارفارد – أمريكا': 'جامعة هارفارد – أمريكا', 'جامعة Algarve – البرتغال': 'جامعة Algarve – البرتغال' }, correctAnswer: 'جامعة هارفارد – أمريكا', points: 1 }, { id: 'ex_mc_q8', image: 'all_q.png', question: 'أيٌّ مما يلي ليس من اختصاص العلاقات الخارجية بحسب الموقع؟', options: { 'برامج التعاون الأكاديمي': 'برامج التعاون الأكاديمي', 'التبادل الأكاديمي': 'التبادل الأكاديمي', 'بوابة الباحثين عن منح': 'بوابة الباحثين عن منح', 'قبول طلبات القبول الجامعي المحلي': 'قبول طلبات القبول الجامعي المحلي' }, correctAnswer: 'قبول طلبات القبول الجامعي المحلي', points: 1 } ],
                
                'cafeteria': { isUnderConstruction: true },
                'grants': { isUnderConstruction: true },
                'hospital': { isUnderConstruction: true },
                'admission': { isUnderConstruction: true },
                'studentaffairs': { isUnderConstruction: true },
                'conference': { isUnderConstruction: true },
                'stadium': { isUnderConstruction: true }
            };

            const gameState = { playerName: '', playerPhone: '', tawjihiYear: '', uniquePlayerId: null, score: 0, currentScene: null, currentSubQuestionIndex: 0, answeredQuestions: new Set() };
            
            // ✅ تم إضافة هذا الكائن لتحديد علاقة المراحل
            const sceneParentMap = {
                'tf_questions': 'faculties',
                'mc_questions': 'faculties',
                'exchange_tf_questions': 'exchange',
                'exchange_mc_questions': 'exchange'
            };

            const landingScreen = document.getElementById('landing-screen');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const startScreen = document.getElementById('start-screen');
            const gameSceneContainer = document.getElementById('game-scene');
            const playerForm = document.getElementById('player-form');
            const playerNameSpan = document.getElementById('player-name');
            const playerScoreSpan = document.getElementById('player-score');
            const playerStats = document.getElementById('player-stats');
            const modal = document.getElementById('feedback-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const correctSound = document.getElementById('correct-sound');
            const incorrectSound = document.getElementById('incorrect-sound');
            const transitionSound = document.getElementById('transition-sound');

            showRegisterBtn.addEventListener('click', () => {
                landingScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            });

            function startGame(event) {
                event.preventDefault();
                const nameInput = document.getElementById('name').value.trim();
                const phoneInput = document.getElementById('phone').value.trim();
                const tawjihiYearInput = document.getElementById('tawjihi-year').value.trim();
                const nameRegex = /^[\u0600-\u06FFa-zA-Z\s]+$/;
                if (nameInput.length < 5 || !nameRegex.test(nameInput)) {
                    showModal('تنبيه بخصوص الاسم', 'هذا الاسم سيتم استخدامه في الشهادة، الرجاء كتابته بشكل صحيح (5 حروف على الأقل، وبدون أرقام أو رموز).', null);
                    return;
                }
                const currentYear = new Date().getFullYear();
                const phoneRegex = /^059\d{7}$/;
                const tawjihiYear = parseInt(tawjihiYearInput);
                if (phoneInput === '' || tawjihiYearInput === '') {
                    showModal('خطأ في الإدخال', 'الرجاء تعبئة جميع الحقول.', null);
                    return;
                }
                if (!phoneRegex.test(phoneInput)) {
                    showModal('خطأ في رقم الجوال', 'الرجاء إدخال رقم جوال صحيح يبدأ بـ 059.', null);
                    return;
                }
                if (tawjihiYear < 2000 || tawjihiYear > currentYear + 1) {
                    showModal('خطأ في سنة التوجيهي', 'الرجاء إدخال سنة توجيهي منطقية (مثال: 2024).', null);
                    return;
                }
                const startButton = event.target.querySelector('.action-button');
                startButton.disabled = true;
                startButton.textContent = 'جاري التسجيل...';
                registerPlayer(nameInput, phoneInput, tawjihiYearInput)
                    .then(data => {
                        if (data.result === 'success' && data.uniqueId) {
                            gameState.playerName = nameInput;
                            gameState.playerPhone = phoneInput;
                            gameState.tawjihiYear = tawjihiYearInput;
                            gameState.uniquePlayerId = data.uniqueId;
                            updatePlayerStats();
                            startScreen.classList.add('hidden');
                            gameSceneContainer.classList.remove('hidden');
                            playerStats.classList.remove('hidden');
                            showModal(`أهلاً بك يا ${gameState.playerName}!`, 'تم تسجيلك بنجاح. هيا بنا نبدأ الرحلة.', () => {
                                renderScene('gate');
                            });
                        } else {
                            showModal('خطأ في التسجيل', 'حدث خطأ أثناء التسجيل. الرجاء المحاولة مرة أخرى.', null);
                            startButton.disabled = false;
                            startButton.textContent = 'ابدأ الرحلة!';
                        }
                    })
                    .catch(error => {
                        showModal('خطأ في الاتصال', 'فشل الاتصال بالخادم. الرجاء التحقق من اتصالك بالإنترنت.', null);
                        startButton.disabled = false;
                        startButton.textContent = 'ابدأ الرحلة!';
                    });
            }

            function showEndScene() {
                document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));
                const endScene = document.getElementById('end-scene');
                const finalMessage = document.getElementById('final-message');
                finalMessage.textContent = `أحسنت يا ${gameState.playerName}! لقد أتممت رحلتك بنجاح وأظهرت معرفة ممتازة بالجامعة الإسلامية. رصيدك النهائي هو ${gameState.score} جنيهًا، ويمكنك الآن الحصول على شهادة المشاركة.`;
                endScene.classList.remove('hidden');
                if (gameState.uniquePlayerId) {
                    updatePlayerScore(gameState.uniquePlayerId, gameState.score);
                } else {
                    console.error("خطأ: لا يمكن تحديث النتيجة لعدم وجود رقم تعريفي.");
                }
            }

            function renderScene(sceneId, questionIndex = 0, pushState = true) {
                if (transitionSound) {
                    transitionSound.play();
                }
                
                if (pushState) {
                    history.pushState({ scene: sceneId, index: questionIndex }, '');
                }
                document.querySelectorAll('.game-stage').forEach(stage => stage.classList.add('hidden'));

                if (sceneId === 'map') {
                    document.getElementById('map-scene').classList.remove('hidden');
                    return;
                }

                const sceneElementId = `${sceneId}-scene`;
                const sceneElement = document.getElementById(sceneElementId);
                let sceneData = gameData[sceneId];

                if (!sceneData || !sceneElement) {
                    console.error(`Scene data or element not found for: ${sceneId}`);
                    showModal("خطأ", "حدث خطأ غير متوقع، سنعيدك للخريطة.", () => renderScene('map'));
                    return;
                }

                gameState.currentScene = sceneId;
                if (Array.isArray(sceneData)) {
                    gameState.currentSubQuestionIndex = questionIndex;
                    sceneData = sceneData[questionIndex];
                }
                
                let progressBarHTML = '';
                if (Array.isArray(gameData[sceneId])) {
                    const totalQuestions = gameData[sceneId].length;
                    const currentProgress = ((questionIndex + 1) / totalQuestions) * 100;
                    progressBarHTML = `<div class="progress-bar-container"><div class="progress-bar" style="width: ${currentProgress}%"></div></div>`;
                }
                
                let optionsHTML = '';
                let delay = 0;
                for (const key in sceneData.options) {
                    optionsHTML += `<button class="option-btn" data-answer="${key}" style="animation-delay: ${delay}s">${sceneData.options[key]}</button>`;
                    delay += 0.1;
                }
                sceneElement.innerHTML = `
                    <img src="${sceneData.image}" alt="صورة مشهد ${sceneId}" class="scene-image">
                    <div class="scene-content">
                        ${progressBarHTML}
                        <p class="scene-title">${sceneData.question}</p>
                        <div class="options-container">${optionsHTML}</div>
                        <div class="feedback-message"></div>
                    </div>
                `;
                sceneElement.classList.remove('hidden');
                sceneElement.querySelector('.options-container').addEventListener('click', handleAnswer);
            }

            function handleAnswer(event) {
                const targetButton = event.target.closest('.option-btn');
                if (!targetButton || targetButton.disabled) return;

                const sceneId = gameState.currentScene;
                let sceneData = gameData[sceneId];
                let questionId;

                if (Array.isArray(sceneData)) {
                    sceneData = sceneData[gameState.currentSubQuestionIndex];
                    questionId = sceneData.id;
                } else {
                    questionId = sceneData.id || sceneId;
                }

                if (gameState.answeredQuestions.has(questionId)) return;

                const selectedAnswer = targetButton.dataset.answer;
                
                if (sceneData.nextScene && sceneData.nextScene[selectedAnswer]) {
                    renderScene(sceneData.nextScene[selectedAnswer]);
                    return;
                }

                const feedbackElement = document.querySelector(`#${sceneId}-scene .feedback-message`);
                const isCorrect = selectedAnswer === sceneData.correctAnswer;
                
                if (isCorrect) {
                    document.querySelectorAll(`#${sceneId}-scene .option-btn`).forEach(btn => btn.disabled = true);
                    
                    correctSound.play();
                    gameState.score += sceneData.points;
                    updatePlayerStats();
                    if (gameState.uniquePlayerId) {
                        updatePlayerScore(gameState.uniquePlayerId, gameState.score);
                    }
                    
                    targetButton.classList.add('correct');
                    feedbackElement.textContent = sceneData.correctFeedback || 'إجابة صحيحة! لقد ربحت جنيهًا واحدًا.';
                    feedbackElement.className = 'feedback-message correct';
                    feedbackElement.style.display = 'block';

                    gameState.answeredQuestions.add(questionId);

                    setTimeout(() => {
                        if (sceneId === 'gate') {
                            renderScene('map');
                        } else if (Array.isArray(gameData[sceneId])) {
                            const nextQuestionIndex = gameState.currentSubQuestionIndex + 1;
                            if (nextQuestionIndex < gameData[sceneId].length) {
                                renderScene(sceneId, nextQuestionIndex);
                            } else {
                                // ✅ --- بداية الكود المعدل ---
                                const parentScene = sceneParentMap[sceneId];

                                if (parentScene) { // إذا كانت هذه المرحلة تابعة لمرحلة اختيار أخرى
                                    const siblingScenes = Object.values(gameData[parentScene].nextScene);
                                    const allSiblingsCompleted = siblingScenes.every(siblingId => isStageCompleted(siblingId));

                                    if (allSiblingsCompleted) {
                                        // أنهى اللاعب كل أنواع الأسئلة، الآن يمكنه العودة للخريطة
                                        showModal("إنجاز مذهل!", `لقد أكملت كل تحديات هذا القسم بنجاح. لنعد إلى الخريطة.`, () => renderScene('map'));
                                    } else {
                                        // أنهى نوعاً واحداً فقط، نرجعه لصفحة الاختيار
                                        showModal("رائع!", `لقد أتممت هذا التحدي. يمكنك الآن تجربة النوع الآخر من الأسئلة.`, () => renderScene(parentScene));
                                    }
                                } else {
                                    // إذا كانت مرحلة عادية (مثل المكتبة)، نرجعه للخريطة مباشرة
                                    showModal("إنجاز رائع!", `لقد أكملت جميع تحديات هذا القسم بنجاح. لنعد إلى الخريطة.`, () => renderScene('map'));
                                }
                                // --- نهاية الكود المعدل ---
                            }
                        } else {
                            renderScene('map');
                        }
                    }, 2000);

                } else {
                    incorrectSound.play();
                    targetButton.disabled = true; 
                    targetButton.classList.add('incorrect');
                    feedbackElement.textContent = sceneData.incorrectFeedback || 'إجابة غير صحيحة. حاول مرة أخرى!';
                    feedbackElement.className = 'feedback-message incorrect';
                    feedbackElement.style.display = 'block';

                    setTimeout(() => {
                        targetButton.disabled = false;
                        targetButton.classList.remove('incorrect');
                        feedbackElement.style.display = 'none';
                    }, 1500);
                }
            }

            function updatePlayerStats() {
                playerNameSpan.textContent = `اللاعب: ${gameState.playerName}`;
                playerScoreSpan.innerHTML = `الرصيد: <span id="player-score-value">${gameState.score}</span> جنيه`;
            }

            function showModal(title, text, callback) {
                modalTitle.textContent = title;
                modalText.innerHTML = text;
                modal.classList.remove('hidden');
                modalCloseBtn.onclick = () => {
                    modal.classList.add('hidden');
                    if (callback) callback();
                };
            }
            
            function isStageCompleted(stageId) {
                const stageData = gameData[stageId];
                if (!stageData || !Array.isArray(stageData)) {
                    // This handles cases where a scene might not be an array of questions,
                    // for the purpose of our check, we can consider it "not completable" in this manner.
                    // A more robust check might be needed if game structure changes, but this is fine for now.
                    if(gameData[stageId]){
                         const subScenes = Object.values(gameData[stageId].nextScene || {});
                         if(subScenes.length > 0){
                            return subScenes.every(s => isStageCompleted(s));
                         }
                    }
                    return false;
                }
                return stageData.every(q => gameState.answeredQuestions.has(q.id));
            }
            
            playerForm.addEventListener('submit', startGame);

            document.getElementById('map-scene').addEventListener('click', (e) => {
                const button = e.target.closest('.option-btn');
                if (!button) return;

                const destination = button.dataset.destination;
                const destinationData = gameData[destination];

                if (destination === 'certificate') {
                    const libraryComplete = isStageCompleted('library');
                    const facultiesComplete = isStageCompleted('faculties'); // Check parent stage
                    const exchangeComplete = isStageCompleted('exchange'); // Check parent stage
                    
                    const allKeyStagesComplete = libraryComplete && facultiesComplete && exchangeComplete;
                    const scoreSufficient = gameState.score >= 50;

                    if (allKeyStagesComplete && scoreSufficient) {
                        showEndScene();
                    } else {
                        let message = "الطريق إلى الشهادة لم يكتمل بعد!<br><br>للحصول عليها، يجب عليك تحقيق شرطين:<br>";
                        message += `1. إكمال تحديات المكتبة، والكليات (كلا المسارين)، والتبادل (كلا المسارين).<br>`;
                        message += `(${libraryComplete ? '✔️' : '❌'} المكتبة) | `;
                        message += `(${facultiesComplete ? '✔️' : '❌'} الكليات) | `;
                        message += `(${exchangeComplete ? '✔️' : '❌'} التبادل)<br>`;
                        message += `2. الحصول على 50 جنيهًا على الأقل (رصيدك: ${gameState.score}). (${scoreSufficient ? '✔️' : '❌'})<br><br>استمر في رحلتك!`;
                        showModal("شروط الحصول على الشهادة", message, null);
                    }
                    return;
                }
                
                if (destinationData && destinationData.isUnderConstruction) {
                    showModal("قيد الإنشاء!", "هذا الجزء من الجامعة سيتم افتتاحه قريباً في التحديثات القادمة للعبة.", null);
                    return;
                }

                if (isStageCompleted(destination)) {
                     showModal("مكان مألوف!", "لقد أكملت جميع تحديات هذا المكان. اختر وجهة أخرى.", null);
                } else if (destinationData) {
                    renderScene(destination);
                } else {
                     showModal("خطأ", "لم يتم العثور على الوجهة المطلوبة.", null);
                }
            });

            document.getElementById('restart-btn').addEventListener('click', () => { location.reload(); });
            
            window.addEventListener('popstate', (event) => {
                if (event.state && event.state.scene) {
                    renderScene(event.state.scene, event.state.index, false);
                } else {
                    location.reload();
                }
            });
        });
    </script>
</body>
</html>
